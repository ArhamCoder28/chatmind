<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>Dashboard - ChatMind</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
    <link rel="stylesheet" href="/static/dashboard.css">
    <link rel="stylesheet" href="/static/css/message-reactions.css">
    <style>
        /* Complete Chat Manager Styles */
        .chat-manager {
            display: flex;
            height: calc(100vh - 80px);
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .chat-sidebar {
            width: 350px;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        .chat-sidebar.collapsed {
            width: 60px;
        }
        .chat-sidebar.collapsed .sidebar-title span,
        .chat-sidebar.collapsed .chat-search,
        .chat-sidebar.collapsed .chat-filters {
            display: none;
        }
        .chat-sidebar.collapsed .conversations-container {
            padding: 8px 4px;
            display: block !important;
        }
        .chat-sidebar.collapsed .conversation-item {
            padding: 0px 20px 0px 0px;
            justify-content: center;
            border-radius: 12px;
            width: 44px;
            height: 44px;
            margin: 6px auto;
            display: flex !important;
            align-items: center;
        }
        .chat-sidebar.collapsed .conversation-info,
        .chat-sidebar.collapsed .conversation-meta {
            display: none !important;
        }
        .chat-sidebar.collapsed .conversation-avatar {
            width: 36px !important;
            height: 36px !important;
            font-size: 1rem !important;
            margin: 0 !important;
        }
        .chat-sidebar.collapsed .online-indicator {
            bottom: 0px;
            right: 0px;
            width: 10px;
            height: 10px;
        }
        .chat-sidebar.collapsed .sidebar-title {
            justify-content: center;
        }
        .chat-sidebar.collapsed .chat-sidebar-header {
            justify-content: space-between;
            padding: 15px 8px;
            flex-direction: column;
            gap: 8px;
        }
        .chat-sidebar.collapsed .sidebar-actions {
            display: flex;
            justify-content: center;
        }
        .chat-sidebar.collapsed .sidebar-btn {
            width: 32px;
            height: 32px;
        }
        .chat-sidebar.collapsed .sidebar-title i {
            font-size: 1.2rem;
        }
        .chat-sidebar.collapsed #newChatBtn {
            display: none;
        }
        .chat-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }
        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        .sidebar-title i {
            color: #6366f1;
            font-size: 1.4rem;
        }
        .sidebar-actions {
            display: flex;
            gap: 8px;
        }
        .sidebar-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: #f1f5f9;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .sidebar-btn:hover {
            background: #6366f1;
            color: white;
            transform: translateY(-1px);
        }
        .chat-search {
            padding: 16px 20px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
        }
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input-wrapper i {
            position: absolute;
            left: 12px;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .search-input-wrapper input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .search-input-wrapper input:focus {
            border-color: #6366f1;
            background: white;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        .clear-search {
            position: absolute;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-search:hover {
            background: #f1f5f9;
            color: #64748b;
        }
        .chat-filters {
            display: flex;
            padding: 12px 20px;
            gap: 8px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
        }
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: transparent;
            color: #64748b;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        .filter-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        .conversations-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .conversations-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .conversation-item {
            padding: 0px 20px 0px 0px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        .conversation-item:hover {
            background: rgba(99,102,241,0.1);
        }
        .conversation-item.active {
            background: #6366f1;
            color: white;
        }
        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }
        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
        }
        .offline-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #94a3b8;
            border: 2px solid white;
            border-radius: 50%;
        }
        .conversation-info {
            flex: 1;
            min-width: 0;
        }
        .conversation-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: inherit;
        }
        .conversation-preview {
            font-size: 0.85rem;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversation-item.active .conversation-preview {
            color: rgba(255,255,255,0.8);
        }
        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .conversation-time {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        .conversation-item.active .conversation-time {
            color: rgba(255,255,255,0.7);
        }
        .unread-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        /* Outstanding Friends Section Styles */
        .friends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 4px;
        }
        .friends-header h2 {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .friends-header h2 i {
            color: #6366f1;
        }
        .friends-stats {
            display: flex;
            gap: 12px;
        }
        .stat-badge {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(99,102,241,0.3);
        }
        .friends-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        .friends-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        .card-header i {
            color: #6366f1;
            font-size: 1.2rem;
        }
        .card-header h3 {
            color: #1e293b;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        .request-count {
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            margin-left: auto;
        }
        .add-friend-form {
            max-width: 500px;
        }
        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .friend-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        .friend-input:focus {
            border-color: #6366f1;
            background: white;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        .send-request-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
        }
        .send-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99,102,241,0.4);
        }
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .request-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .request-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .request-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .request-info h4 {
            margin: 0;
            color: #1e293b;
            font-weight: 600;
        }
        .request-info p {
            margin: 4px 0 0 0;
            color: #64748b;
            font-size: 0.85rem;
        }
        .request-actions {
            display: flex;
            gap: 8px;
        }
        .accept-btn, .reject-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }
        .accept-btn {
            background: #10b981;
            color: white;
        }
        .accept-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        .reject-btn {
            background: #ef4444;
            color: white;
        }
        .reject-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .friend-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        .friend-card:hover {
            background: white;
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99,102,241,0.15);
        }
        .friend-card-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.5rem;
            margin: 0 auto 12px;
            position: relative;
            overflow: hidden;
        }
        .friend-card-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .friend-status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            border: 3px solid white;
            border-radius: 50%;
        }
        .friend-status-dot.online {
            background: #10b981;
        }
        .friend-status-dot.offline {
            background: #94a3b8;
        }
        .friend-card h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-weight: 600;
        }
        .friend-card p {
            margin: 0 0 16px 0;
            color: #64748b;
            font-size: 0.9rem;
        }
        .chat-friend-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }
        .chat-friend-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
        }
        /* Friend Card Menu */
        .friend-card-menu {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        .friend-menu-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255,255,255,0.8);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s ease;
            opacity: 1;
        }
        .friend-menu-btn:hover {
            background: white;
            color: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .friend-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 140px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        .friend-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .friend-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            color: #374151;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        .friend-dropdown-item:hover {
            background: #f8fafc;
        }
        .friend-dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        .friend-dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        .friend-dropdown-item i {
            width: 14px;
            color: #64748b;
        }
        .friend-dropdown-item.danger {
            color: #ef4444;
        }
        .friend-dropdown-item.danger i {
            color: #ef4444;
        }
        
        /* Submenu styles */
        .dropdown-submenu {
            position: relative;
        }
        
        .friend-dropdown-submenu {
            position: absolute;
            top: 0;
            left: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-10px);
            transition: all 0.2s ease;
        }
        
        .friend-dropdown-submenu.show {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateX(0) !important;
        }
        
        .dropdown-submenu:hover .friend-dropdown-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        
        /* Ensure submenu items are clickable */
        .friend-dropdown-submenu .friend-dropdown-item {
            white-space: nowrap;
        }
        
        /* Member dropdown styles */
        .member-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            color: #374151;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        .member-dropdown-item:hover {
            background: #f8fafc;
        }
        .member-dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        .member-dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        .member-dropdown-item.danger {
            color: #ef4444;
        }
        .member-dropdown-item.danger:hover {
            background: #fef2f2;
        }
        .member-menu-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .member-menu-btn:hover {
            background: #e2e8f0;
            color: #374151;
        }
        .member-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        .member-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 350px;
        }
        .notification {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border-left: 4px solid #6366f1;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .notification.success {
            border-left-color: #10b981;
        }
        .notification.error {
            border-left-color: #ef4444;
        }
        .notification.warning {
            border-left-color: #f59e0b;
        }
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
        }
        .notification.success .notification-icon {
            background: #10b981;
        }
        .notification.error .notification-icon {
            background: #ef4444;
        }
        .notification.warning .notification-icon {
            background: #f59e0b;
        }
        .notification-content h4 {
            margin: 0 0 4px 0;
            color: #1e293b;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .notification-content p {
            margin: 0;
            color: #64748b;
            font-size: 0.85rem;
        }
        .notification-close {
            margin-left: auto;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .notification-close:hover {
            background: #f1f5f9;
            color: #64748b;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        .chat-welcome {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .welcome-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
        }
        .welcome-icon {
            font-size: 4rem;
            color: #6366f1;
            margin-bottom: 24px;
        }
        .welcome-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }
        .welcome-content p {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 32px;
        }
        .welcome-features {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .feature-item i {
            color: #6366f1;
            font-size: 1.2rem;
        }
        .feature-item span {
            color: #475569;
            font-weight: 500;
        }
        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background: #f8fafc;
            color: #1e293b;
        }
        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        .dropdown-item i {
            width: 16px;
            text-align: center;
            color: #64748b;
        }
        .dropdown-item:hover i {
            color: #374151;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }
        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-header .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .user-details {
            display: flex;
            flex-direction: column;
        }
        .user-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }
        .user-status {
            font-size: 0.85rem;
            color: #64748b;
        }
        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: #f8fafc;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .header-btn:hover {
            background: #6366f1;
            color: white;
            transform: translateY(-1px);
        }
        .messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(180deg, #fafbfc 0%, #f8fafc 100%);
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }
        .message-bubble.received {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 4px;
        }
        .message-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }
        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 8px;
            transition: all 0.3s ease;
        }
        .input-container:focus-within {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        .input-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .input-btn:hover {
            background: #e2e8f0;
            color: #374151;
        }
        .message-input-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .message-input-wrapper textarea {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 1rem;
            line-height: 1.5;
            padding: 8px 0;
            max-height: 120px;
            min-height: 24px;
            color: #374151;
        }
        .message-input-wrapper textarea::placeholder {
            color: #9ca3af;
        }
        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
        }
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99,102,241,0.4);
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* Mobile floating toggle */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 100px;
            left: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
            cursor: pointer;
            font-size: 1.2rem;
        }
        .mobile-chat-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
            cursor: pointer;
            font-size: 1.2rem;
        }
        /* Profile Picture Styles */
        .profile-picture-section {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        .current-profile-picture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .current-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .current-profile-picture .default-avatar {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
        }
        .profile-picture-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .profile-picture-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        .btn-secondary:hover {
            background: #475569;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        /* Notification Badge */
        .notification-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            margin-left: 8px;
            display: inline-block;
        }
        @media (max-width: 768px) {
            .chat-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .chat-sidebar.show {
                transform: translateX(0);
            }
            .mobile-chat-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .chat-main {
                width: 100%;
            }
        }
        /* Profile DP handling with size options - Rectangle shape */
        .profile-dp {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            font-weight: 600 !important;
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
            color: white !important;
            flex-shrink: 0 !important;
            transition: all 0.3s ease !important;
            border-radius: 8px !important;
            border: 3px solid #e2e8f0 !important;
        }
        
        .profile-dp.small {
            width: 100% !important;
            height: 120px !important;
            font-size: 2rem !important;
        }
        
        .profile-dp.medium {
            width: 100% !important;
            height: 150px !important;
            font-size: 2.5rem !important;
        }
        
        .profile-dp.large {
            width: 100% !important;
            height: 180px !important;
            font-size: 3rem !important;
        }
        
        .profile-dp img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 8px !important;
        }
        
        /* Avatar section layout */
        .avatar-section {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        /* Avatar action buttons */
        .avatar-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .upload-btn, .remove-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .upload-btn {
            background: #6366f1;
            color: white;
        }
        
        .upload-btn:hover {
            background: #5855eb;
            transform: translateY(-1px);
        }
        
        .remove-btn {
            background: #ef4444;
            color: white;
        }
        
        .remove-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        /* Desktop Notification */
        .desktop-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border-left: 4px solid #6366f1;
            max-width: 300px;
            z-index: 10000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        .desktop-notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .desktop-notification .notification-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .desktop-notification .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            overflow: hidden;
        }
        .desktop-notification .notification-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .desktop-notification .notification-title {
            font-weight: 600;
            color: #1e293b;
        }
        .desktop-notification .notification-message {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        /* Dark Theme Styles */
        .dark-theme {
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .dark-theme .container {
            background: #1a1a1a;
        }
        
        .dark-theme .sidebar {
            background: #2d2d2d;
            border-right: 1px solid #404040;
        }
        
        .dark-theme .sidebar-menu a {
            color: #e0e0e0;
        }
        
        .dark-theme .sidebar-menu a:hover {
            background: #404040;
            color: #ffffff;
        }
        
        .dark-theme .sidebar-menu a.active {
            background: #6366f1;
            color: #ffffff;
        }
        
        .dark-theme .sidebar-title {
            color: #b0b0b0;
        }
        
        .dark-theme .main-content {
            background: #1a1a1a;
        }
        
        .dark-theme header {
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
        }
        
        .dark-theme h1, .dark-theme h2, .dark-theme h3, .dark-theme h4, .dark-theme h5 {
            color: #ffffff;
        }
        
        .dark-theme p, .dark-theme span, .dark-theme div {
            color: #e0e0e0;
        }
        
        .dark-theme .friends-card, .dark-theme .neo-card {
            background: #3a3a3a;
            border: 1px solid #555555;
        }
        
        .dark-theme .friend-card {
            background: #4a4a4a;
            border: 1px solid #666666;
        }
        
        .dark-theme .friend-card:hover {
            background: #525252;
            border-color: #6366f1;
        }
        
        .dark-theme .group-card {
            background: #4a4a4a;
            border: 1px solid #666666;
        }
        
        .dark-theme .group-card:hover {
            background: #525252;
            border-color: #6366f1;
        }
        
        .dark-theme .friend-input, .dark-theme .modern-input {
            background: #404040;
            border: 1px solid #555555;
            color: #ffffff;
        }
        
        .dark-theme .friend-input:focus, .dark-theme .modern-input:focus {
            border-color: #6366f1;
            background: #4a4a4a;
        }
        
        .dark-theme .chat-manager {
            background: #2d2d2d;
        }
        
        .dark-theme .chat-sidebar {
            background: #2d2d2d;
            border-right: 1px solid #404040;
        }
        
        .dark-theme .conversation-item {
            color: #e0e0e0;
        }
        
        .dark-theme .conversation-item:hover {
            background: rgba(99,102,241,0.2);
        }
        
        .dark-theme .messages-area {
            background: #1a1a1a;
        }
        
        .dark-theme .message-bubble.received {
            background: #404040;
            color: #ffffff;
            border: 1px solid #555555;
        }
        
        .dark-theme .desktop-notification {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        .dark-theme .desktop-notification .notification-title {
            color: #ffffff;
        }
        
        .dark-theme .desktop-notification .notification-message {
            color: #b0b0b0;
        }
        
        .dark-theme .stat-card {
            background: #3a3a3a;
            border: 1px solid #555555;
        }
        
        .dark-theme .stat-item {
            background: #4a4a4a;
            border: 1px solid #666666;
        }
        
        .dark-theme .group-card {
            background: #3a3a3a !important;
            border: 1px solid #555555 !important;
        }
        
        .dark-theme .group-card:hover {
            background: #4a4a4a !important;
            border-color: #6366f1 !important;
        }
        
        .dark-theme .groups-grid {
            background: #1a1a1a;
        }
        
        .dark-theme .groups-grid .group-card {
            background: #3a3a3a !important;
            border: 1px solid #555555 !important;
        }
        
        .dark-theme .groups-grid .group-card:hover {
            background: #4a4a4a !important;
            border-color: #6366f1 !important;
        }
        
        .dark-theme .modern-group-card {
            background: #2a2a2a !important;
            border: 1px solid #444444 !important;
        }
        
        .dark-theme .modern-group-card:hover {
            background: #3a3a3a !important;
            border-color: #6366f1 !important;
        }
        
        .dark-theme .group-card-header {
            background: #1f1f1f !important;
            border-bottom: 1px solid #333333 !important;
        }
        
        .dark-theme .group-action-btn.secondary {
            background: #404040 !important;
            color: #e0e0e0 !important;
            border: 1px solid #555555 !important;
        }
        
        .dark-theme .group-action-btn.secondary:hover {
            background: #4a4a4a !important;
            border-color: #6366f1 !important;
        }
        
        .dark-theme .modal-container {
            background: rgba(0, 0, 0, 0.8) !important;
        }
        
        .dark-theme .modal-content {
            background: #2d2d2d !important;
            border: 1px solid #404040 !important;
        }
        
        .dark-theme .notification-container {
            background: #2d2d2d !important;
            border: 1px solid #404040 !important;
        }
        
        .dark-theme .notification {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        
        
        .dark-theme .group-action-btn.secondary:hover {
            background: #4a4a4a !important;
            border-color: #6366f1 !important;
        }
    </style>
</head>
<body class="{% if user_role == 'admin' %}admin{% endif %} dark-theme">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-section="home"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                <li><a href="#" data-section="messages"><i class="fas fa-comment"></i> <span>Messages</span> <span class="notification-badge" id="messagesBadge" style="display:none;">0</span></a></li>
                <li><a href="#" data-section="friends"><i class="fas fa-users"></i> <span>Friends</span></a></li>
                
                <div class="sidebar-divider"></div>
                <div class="sidebar-title">Communities</div>
                
                <li><a href="#" data-section="groups"><i class="fas fa-user-friends"></i> <span>Groups</span> <span class="notification-badge" id="groupsBadge" style="display:none;">0</span></a></li>
                <li><a href="#" data-section="favorites"><i class="fas fa-star"></i> <span>Favorites</span></a></li>
                
                <div class="sidebar-divider"></div>
                <div class="sidebar-title" >Settings</div>
                
                <li><a href="#" data-section="settings"><i class="fas fa-cog"></i> <span>Account Settings</span></a></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="logo">
                    <div class="logo-box">
                        <span>C</span>
                    </div>
                    <h1>ChatMind</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="/features">Features</a></li>
                        <li><a href="/about">About</a></li>
                        <li><a href="/contact">Contact</a></li>
                    </ul>
                </nav>
                <div class="user-info">
                    <div class="user-avatar" onclick="goToProfile()" style="cursor:pointer;" title="View Profile">
                        {{ username[0].upper() }}
                    </div>
                    <span>{{ username }}</span>
                    <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </header>
            
            <!-- Notification Container -->
            <div class="notification-container" id="notificationContainer"></div>
            
            <div class="dashboard-content">
                <div class="content-section" id="home" style="display:block;">
                <div class="welcome-section">
                    <h2>Welcome back, {{ username }}!</h2>
                    <p>Ready to connect and chat with your friends and communities?</p>
                    
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-clock"></i> Online Time</h3>
                        <div class="stat-number" id="onlineTime">0m</div>
                        <div style="font-size:0.85rem; color:#cbd5e1; margin-top:6px;">
                            Session started today
                        </div>
                    </div>
                </div>
                </div>

                <div class="content-section" id="friends" style="display:none;">
                    <div class="friends-header">
                        <h2><i class="fas fa-users"></i> Friends</h2>
                        <div class="friends-stats">
                            <span class="stat-badge"><i class="fas fa-user-check"></i> <span id="friendsOnlineCount">0</span> Online</span>
                            <span class="stat-badge"><i class="fas fa-user-friends"></i> <span id="friendsTotalCount">0</span> Total</span>
                        </div>
                    </div>
                    
                    <div class="friends-card">
                        <div class="card-header">
                            <i class="fas fa-user-plus"></i>
                            <h3>Add Friend</h3>
                        </div>
                        <div class="add-friend-form">
                            <div class="input-group">
                                <input id="frUsername" placeholder="Enter username" class="friend-input">
                                <button id="sendFrBtn" class="send-request-btn">
                                    <i class="fas fa-paper-plane"></i> Send Request
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="friends-card" id="requestsCard">
                        <div class="card-header">
                            <i class="fas fa-inbox"></i>
                            <h3>Friend Requests</h3>
                            <span class="request-count" id="requestCount">0</span>
                        </div>
                        <div id="frList" class="requests-list"></div>
                    </div>
                    
                    <div class="friends-card">
                        <div class="card-header">
                            <i class="fas fa-heart"></i>
                            <h3>My Friends</h3>
                        </div>
                        <div id="acceptedFriendsList" class="friends-grid"></div>
                    </div>
                </div>

                <div class="content-section" id="messages" style="display:none;">
                    <div class="chat-manager">
                        <!-- Chat Sidebar -->
                        <div class="chat-sidebar" id="chatSidebar">
                            <div class="chat-sidebar-header">
                                <div class="sidebar-title">
                                    <i class="fas fa-comments"></i>
                                    <span>Messages</span>
                                </div>
                                <div class="sidebar-actions">
                                    <button class="sidebar-btn" id="newChatBtn" title="New Chat">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="sidebar-btn" id="toggleSidebarBtn" title="Toggle Sidebar">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="chat-search">
                                <div class="search-input-wrapper">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="chatSearchInput" placeholder="Search conversations...">
                                    <button class="clear-search" id="clearSearchBtn" style="display:none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="chat-filters">
                                <button class="filter-btn active" data-filter="all">
                                    <i class="fas fa-comments"></i> All
                                </button>
                                <button class="filter-btn" data-filter="unread">
                                    <i class="fas fa-circle"></i> Unread
                                </button>
                                <button class="filter-btn" data-filter="online">
                                    <i class="fas fa-user-check"></i> Online
                                </button>
                            </div>
                            
                            <div class="conversations-container">
                                <div id="conversationsList" class="conversations-list"></div>
                            </div>
                        </div>
                        
                        <!-- Chat Main Area -->
                        <div class="chat-main" id="chatMain">
                            <div class="chat-welcome" id="chatWelcome">
                                <div class="welcome-content">
                                    <div class="welcome-icon">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <h3>Welcome to ChatMind</h3>
                                    <p>Select a conversation to start messaging</p>
                                    <div class="welcome-features">
                                        <div class="feature-item">
                                            <i class="fas fa-bolt"></i>
                                            <span>Real-time messaging</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-shield-alt"></i>
                                            <span>Secure & private</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-users"></i>
                                            <span>Connect with friends</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-container" id="chatContainer" style="display:none;">
                                <!-- Chat Header -->
                                <div class="chat-header">
                                    <div class="chat-user-info">
                                        <div class="user-avatar" id="currentChatAvatar">?</div>
                                        <div class="user-details">
                                            <div class="user-name" id="currentChatName">Select a chat</div>
                                            <div class="user-status" id="currentChatStatus">Offline</div>
                                        </div>
                                    </div>
                                    <div class="chat-header-actions">
                                        <button class="header-btn" id="toggleConversationsBtn" title="Toggle Conversations">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <button class="header-btn" id="searchMessagesBtn" title="Search Messages">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button class="header-btn" id="callBtn" title="Voice Call">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="header-btn" id="videoCallBtn" title="Video Call">
                                            <i class="fas fa-video"></i>
                                        </button>
                                        <button class="header-btn" id="chatInfoBtn" title="Chat Info">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <div class="dropdown">
                                            <button class="header-btn dropdown-toggle" id="chatMenuBtn" title="More Options">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div class="dropdown-menu" id="chatDropdownMenu">
                                                <button class="dropdown-item" id="muteBtn">
                                                    <i class="fas fa-volume-mute"></i> Mute
                                                </button>
                                                <button class="dropdown-item" id="clearChatBtn">
                                                    <i class="fas fa-trash"></i> Clear Chat (For Me)
                                                </button>
                                                <button class="dropdown-item" id="blockUserBtn">
                                                    <i class="fas fa-ban"></i> Block User
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Messages Area -->
                                <div class="messages-area" id="messagesArea">
                                    <div class="messages-container" id="messagesContainer">
                                        <div class="messages-list" id="messagesList"></div>
                                    </div>
                                    <div class="typing-indicator" id="typingIndicator" style="display:none;">
                                        <div class="typing-dots">
                                            <span></span><span></span><span></span>
                                        </div>
                                        <span class="typing-text">Someone is typing...</span>
                                    </div>
                                </div>
                                
                                <!-- Message Input -->
                                <div class="message-input-area">
                                    <div class="input-container">
                                        <button class="input-btn" id="attachBtn" title="Attach File">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <div class="message-input-wrapper">
                                            <textarea id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                                            <button class="input-btn" id="emojiBtn" title="Emoji">
                                                <i class="fas fa-smile"></i>
                                            </button>
                                        </div>
                                        <button class="send-btn" id="sendBtn" title="Send Message">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    <div class="input-actions">
                                        <div class="file-upload" id="fileUpload" style="display:none;">
                                            <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
                                            <div class="upload-area">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                <span>Drop files here or click to upload</span>
                                            </div>
                                        </div>
                                        <div class="emoji-picker" id="emojiPicker" style="display:none;">
                                            <div class="emoji-grid">
                                                <span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span>
                                                <span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span>
                                                <span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span>
                                                <span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span><span class="emoji-item"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fullscreen Chat Overlay -->
                <div class="chat-overlay" id="chatOverlay">
                    <div class="chat-panel">
                        <div class="chat-panel-header">
                            <div class="chat-panel-title" id="overlayTitle">Chat</div>
                            <button class="chat-panel-close" id="overlayClose">&times;</button>
                        </div>
                        <div class="chat-panel-body">
                            <div class="chat-panel-messages" id="overlayMessages"></div>
                            <div class="chat-panel-input">
                                <input id="overlayInput" placeholder="Type a message" />
                                <button id="overlaySend">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

              
                <div class="content-section" id="groups" style="display:none;">
                    <div class="modern-groups-container">
                        <div class="groups-header-modern">
                            <div class="groups-title-section">
                                <div class="groups-icon-wrapper">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="groups-title-content">
                                    <h1>My Groups</h1>
                                    <p>Connect and collaborate with your communities</p>
                                </div>
                            </div>
                            <button class="create-group-btn" id="createGroupBtn">
                                <i class="fas fa-plus"></i>
                                <span>Create Group</span>
                            </button>
                        </div>

                        <div class="groups-stats-bar">
                            <div class="stat-item">
                                <div class="stat-icon groups-stat">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="totalGroupsCount">0</span>
                                    <span class="stat-label">Total Groups</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon members-stat">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="totalMembersCount">0</span>
                                    <span class="stat-label">Total Members</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon active-stat">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="activeChatsCount">0</span>
                                    <span class="stat-label">Active Chats</span>
                                </div>
                            </div>
                        </div>

                        <div class="groups-grid" id="groupsList"></div>
                    </div>
                    
                    <!-- Modern Create Group Modal -->
                    <div id="createGroupModal" class="modern-modal" style="display:none;">
                        <div class="modal-backdrop"></div>
                        <div class="modal-container">
                            <div class="modal-header">
                                <div class="modal-title">
                                    <div class="modal-icon create-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <span>Create New Group</span>
                                </div>
                                <button class="modal-close" id="cancelCreateGroup">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-content">
                                <div class="modern-input-group">
                                    <label class="modern-label">
                                        <i class="fas fa-tag"></i>
                                        <span>Group Name</span>
                                    </label>
                                    <input type="text" id="groupName" class="modern-input" placeholder="Enter group name" maxlength="50">
                                </div>
                                <div class="modern-input-group">
                                    <label class="modern-label">
                                        <i class="fas fa-align-left"></i>
                                        <span>Description (Optional)</span>
                                    </label>
                                    <textarea id="groupDescription" class="modern-input" placeholder="Enter group description" rows="3"></textarea>
                                </div>
                                <div class="privacy-toggle">
                                    <div class="toggle-info">
                                        <div class="toggle-icon">
                                            <i class="fas fa-lock"></i>
                                        </div>
                                        <div class="toggle-details">
                                            <span class="toggle-title">Private Group</span>
                                            <span class="toggle-desc">Only invited members can join</span>
                                        </div>
                                    </div>
                                    <label class="modern-toggle">
                                        <input type="checkbox" id="groupPrivate" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button class="modern-btn secondary-btn" id="cancelCreateGroup2">Cancel</button>
                                <button class="modern-btn primary-btn" id="createGroupSubmit">
                                    <i class="fas fa-plus"></i>
                                    <span>Create Group</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modern Group Chat Modal -->
                    <div id="groupChatModal" class="group-chat-modal" style="display:none;">
                        <div class="chat-modal-container">
                            <div class="chat-modal-header">
                                <div class="chat-header-info">
                                    <div class="group-avatar" id="groupChatAvatar">G</div>
                                    <div class="group-details">
                                        <h3 id="groupChatTitle">Group Chat</h3>
                                        <span id="groupMemberCount">0 members</span>
                                    </div>
                                </div>
                                <button class="chat-close-btn" id="closeGroupChat">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="chat-messages-area" id="groupMessages"></div>
                            <div class="chat-input-area">
                                <div class="chat-input-container">
                                    <button class="chat-action-btn" title="Attach File">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <div class="message-input-wrapper">
                                        <input type="text" id="groupMessageInput" placeholder="Type a message...">
                                        <button class="chat-action-btn" title="Emoji">
                                            <i class="fas fa-smile"></i>
                                        </button>
                                    </div>
                                    <button class="send-message-btn" id="sendGroupMessage">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section" id="favorites" style="display:none;">
                    <div class="friends-header">
                        <h2><i class="fas fa-star"></i> Favorites</h2>
                        <div class="friends-stats">
                            <span class="stat-badge"><i class="fas fa-heart"></i> <span id="favoritesCount">0</span> Items</span>
                        </div>
                    </div>
                    
                    <div class="friends-card">
                        <div class="card-header">
                            <i class="fas fa-user-friends"></i>
                            <h3>Favorite Friends</h3>
                        </div>
                        <div id="favoriteUsersList" class="friends-grid"></div>
                    </div>
                    
                    <div class="friends-card">
                        <div class="card-header">
                            <i class="fas fa-users"></i>
                            <h3>Favorite Groups</h3>
                        </div>
                        <div id="favoriteGroupsList" class="friends-grid"></div>
                    </div>
                </div>

                <div class="content-section" id="settings" style="display:none;">
                    <div class="neo-settings">
                        <div class="settings-header">
                            <div class="header-glow"></div>
                            <div class="header-content">
                                <div class="header-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <div class="header-text">
                                    <h1>Settings</h1>
                                    <p>Customize your experience</p>
                                </div>
                            </div>
                        </div>

                        <div class="settings-grid">
                            <div class="neo-card profile">
                                <div class="card-header">
                                    <div class="icon-wrapper profile-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <h3>Profile</h3>
                                </div>
                                <div class="card-content">
                                    <div class="avatar-section">
                                        <div class="avatar profile-dp small" id="currentProfilePic">{{ username[0].upper() }}</div>
                                    </div>
                                    <div class="avatar-actions">
                                        <input type="file" id="profilePictureInput" accept="image/*" style="display:none;">
                                        <button class="upload-btn" id="uploadProfilePicBtn">
                                            <i class="fas fa-upload"></i>
                                            Upload
                                        </button>
                                        <button class="remove-btn" id="removeProfilePicBtn" style="display:none;">
                                            <i class="fas fa-trash"></i>
                                            Remove
                                        </button>
                                    </div>
                                    <div class="form-field">
                                        <label>Username</label>
                                        <input type="text" value="{{ username }}" readonly>
                                    </div>
                                    <div class="form-field">
                                        <label>Email</label>
                                        <input type="email" placeholder="Enter your email">
                                    </div>
                                    <div class="form-field">
                                        <label>Profile Picture Size</label>
                                        <select id="dpSizeSelect" class="modern-input">
                                            <option value="small">Small (60px)</option>
                                            <option value="medium">Medium (80px)</option>
                                            <option value="large">Large (100px)</option>
                                        </select>
                                    </div>
                                    <button class="save-btn">
                                        <i class="fas fa-save"></i>
                                        Save Changes
                                    </button>
                                </div>
                            </div>

                            <div class="neo-card appearance">
                                <div class="card-header">
                                    <div class="icon-wrapper appearance-icon">
                                        <i class="fas fa-palette"></i>
                                    </div>
                                    <h3>Appearance</h3>
                                </div>
                                <div class="card-content">
                                    <div class="theme-selector">
                                        <label class="theme-option">
                                            <input type="radio" name="theme" value="light" checked id="lightTheme">
                                            <div class="theme-card light">
                                                <div class="theme-preview">
                                                    <div class="preview-bar"></div>
                                                    <div class="preview-content"></div>
                                                </div>
                                                <div class="theme-label">
                                                    <i class="fas fa-sun"></i>
                                                    Light
                                                </div>
                                            </div>
                                        </label>
                                        <label class="theme-option">
                                            <input type="radio" name="theme" value="dark" id="darkTheme">
                                            <div class="theme-card dark">
                                                <div class="theme-preview">
                                                    <div class="preview-bar"></div>
                                                    <div class="preview-content"></div>
                                                </div>
                                                <div class="theme-label">
                                                    <i class="fas fa-moon"></i>
                                                    Dark
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="neo-card notifications">
                                <div class="card-header">
                                    <div class="icon-wrapper notifications-icon">
                                        <i class="fas fa-bell"></i>
                                    </div>
                                    <h3>Notifications</h3>
                                </div>
                                <div class="card-content">
                                    <div class="toggle-list">
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <i class="fas fa-comment"></i>
                                                <div>
                                                    <h5>Messages</h5>
                                                    <p>New message notifications</p>
                                                </div>
                                            </div>
                                            <label class="neo-toggle">
                                                <input type="checkbox" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <i class="fas fa-user-plus"></i>
                                                <div>
                                                    <h5>Friend Requests</h5>
                                                    <p>New friend request alerts</p>
                                                </div>
                                            </div>
                                            <label class="neo-toggle">
                                                <input type="checkbox" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <i class="fas fa-volume-up"></i>
                                                <div>
                                                    <h5>Sound</h5>
                                                    <p>Play notification sounds</p>
                                                </div>
                                            </div>
                                            <label class="neo-toggle">
                                                <input type="checkbox">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="neo-card security">
                                <div class="card-header">
                                    <div class="icon-wrapper security-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h3>Privacy & Security</h3>
                                </div>
                                <div class="card-content">
                                    <div class="toggle-list">
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <i class="fas fa-eye"></i>
                                                <div>
                                                    <h5>Online Status</h5>
                                                    <p>Show when you're online</p>
                                                </div>
                                            </div>
                                            <label class="neo-toggle">
                                                <input type="checkbox" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info">
                                                <i class="fas fa-user-friends"></i>
                                                <div>
                                                    <h5>Friend Requests</h5>
                                                    <p>Allow friend requests</p>
                                                </div>
                                            </div>
                                            <label class="neo-toggle">
                                                <input type="checkbox" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <button class="neo-btn danger" id="changePasswordBtn">
                                        <i class="fas fa-key"></i>
                                        Change Password
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Password Change Modal -->
                    <div id="passwordModal" class="modern-modal" style="display:none;">
                        <div class="modal-backdrop"></div>
                        <div class="modal-container">
                            <div class="modal-header">
                                <div class="modal-title">
                                    <i class="fas fa-key"></i>
                                    <span>Change Password</span>
                                </div>
                                <button class="modal-close" id="cancelPasswordBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-content">
                                <div class="modern-input-group">
                                    <label class="modern-label">
                                        <i class="fas fa-lock"></i>
                                        <span>Current Password</span>
                                    </label>
                                    <input type="password" id="currentPassword" class="modern-input" placeholder="Enter current password">
                                </div>
                                <div class="modern-input-group">
                                    <label class="modern-label">
                                        <i class="fas fa-key"></i>
                                        <span>New Password</span>
                                    </label>
                                    <input type="password" id="newPassword" class="modern-input" placeholder="Enter new password">
                                </div>
                                <div class="modern-input-group">
                                    <label class="modern-label">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Confirm New Password</span>
                                    </label>
                                    <input type="password" id="confirmPassword" class="modern-input" placeholder="Confirm new password">
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button class="modern-btn secondary-btn" id="cancelPasswordBtn2">Cancel</button>
                                <button class="modern-btn primary-btn" id="updatePasswordBtn">Update Password</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script type="application/json" id="bootstrapSelf">{{ {'id': session['user_id'], 'username': username}|tojson }}</script>
    <script>
        // Identify current user for client-side labeling
        (function(){
            try {
                const self = JSON.parse(document.getElementById('bootstrapSelf').textContent);
                window._selfId = self.id;
                window._selfUsername = self.username || '';
                // Update URL to include user ID
                if (window._selfId && !window.location.pathname.includes('/dashboard/' + window._selfId)) {
                    history.replaceState(null, '', '/dashboard/' + window._selfId);
                }
            } catch (e) {
                window._selfId = null;
                window._selfUsername = '';
            }
        })();
        let sessionStart = localStorage.getItem('sessionStartTime');
        
        if (!sessionStart) {
            sessionStart = Date.now();
            localStorage.setItem('sessionStartTime', sessionStart);
        } else {
            // Convert from string to number
            sessionStart = parseInt(sessionStart);
        }
        
        // Real-time online time tracking
        function updateOnlineTime() {
            const currentTime = Date.now();
            const secondsOnline = Math.floor((currentTime - sessionStart) / 1000);
            
            if (secondsOnline < 60) {
                document.getElementById('onlineTime').textContent = secondsOnline + 's';
            } else if (secondsOnline < 3600) {
                const minutes = Math.floor(secondsOnline / 60);
                const seconds = secondsOnline % 60;
                document.getElementById('onlineTime').textContent = minutes + 'm ' + seconds + 's';
            } else {
                const hours = Math.floor(secondsOnline / 3600);
                const minutes = Math.floor((secondsOnline % 3600) / 60);
                document.getElementById('onlineTime').textContent = hours + 'h ' + minutes + 'm';
            }
        }
        
        // Initialize static values
        
        // Initial online time update
        updateOnlineTime();
        
        // Update only online time
        setInterval(updateOnlineTime, 1000); // Every second

        // Load message stats and keep it fresh
        function loadMessageStats(){
            fetch('/messages/stats').then(r=>r.json()).then(d=>{
                if (!d.success) return;
                const sent = d.sent || 0, recv = d.received || 0;
                const total = sent + recv;
                // Load unseen count
                fetch('/messages/unseen').then(r=>r.json()).then(u=>{
                    if (u && u.success) {
                        const totalUnseen = u.total || 0;
                        updateMessagesBadge(totalUnseen);
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) notificationCount.textContent = totalUnseen;
                        const header = document.getElementById('chatHeader');
                        if (header) {
                            header.textContent = (window._currentChatUsername ? `Chat with ${window._currentChatUsername}` : 'Select a friend to chat') + (totalUnseen ? `    ${totalUnseen} unread` : '');
                        }
                    }
                }).catch(()=>{});
            }).catch(()=>{});
        }
        
        // Update messages badge
        function updateMessagesBadge(count) {
            const badge = document.getElementById('messagesBadge');
            if (!badge) return;
            
            if (count === undefined) {
                // Fetch current count
                fetch('/messages/unseen').then(r=>r.json()).then(u=>{
                    if (u && u.success) {
                        const totalUnseen = u.total || 0;
                        if (totalUnseen > 0) {
                            badge.textContent = totalUnseen;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }).catch(()=>{});
            } else {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Update groups badge
        function updateGroupsBadge(increment = false) {
            const badge = document.getElementById('groupsBadge');
            if (!badge) return;
            
            if (increment) {
                const current = parseInt(badge.textContent) || 0;
                const newCount = current + 1;
                badge.textContent = newCount;
                badge.style.display = 'inline-block';
            } else {
                // Clear badge when groups section is opened
                badge.style.display = 'none';
            }
        }
        

        
        // Show message notification
        function showMessageNotification(msg) {
            // Get sender info
            const senderConv = conversations.find(c => String(c[0]) === String(msg.from));
            const senderName = senderConv ? senderConv[1] : 'Someone';
            const senderPicture = senderConv ? senderConv[4] : null;
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'desktop-notification';
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-avatar">
                        ${senderPicture ? `<img src="${senderPicture}" alt="${senderName}" />` : senderName.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="notification-title">${senderName}</div>
                        <div class="notification-message">${msg.content.length > 50 ? msg.content.substring(0, 50) + '...' : msg.content}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, 4000);
            
            // Click to open chat
            notification.addEventListener('click', () => {
                // Switch to messages section
                document.querySelectorAll('.sidebar-menu a').forEach(x=>x.classList.remove('active'));
                document.querySelector('.sidebar-menu a[data-section="messages"]').classList.add('active');
                document.querySelectorAll('.content-section').forEach(sec=>sec.style.display='none');
                document.getElementById('messages').style.display='block';
                initializeChatSystem();
                
                // Open chat with sender
                setTimeout(() => {
                    const chatItem = document.querySelector(`[data-username="${senderName}"]`);
                    if (chatItem) {
                        chatItem.click();
                    }
                }, 500);
                
                // Hide notification
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            });
        }
        loadMessageStats();
        updateMessagesBadge();
        setInterval(loadMessageStats, 10000);
        
        // Initialize sidebar as closed by default
        (function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            if (sidebar && mainContent) {
                sidebar.classList.add('closed');
                mainContent.classList.add('sidebar-closed');
            }
        })();
        
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar.classList.contains('closed')) {
                // Open sidebar
                sidebar.classList.remove('closed');
                mainContent.classList.remove('sidebar-closed');
            } else {
                // Close sidebar
                sidebar.classList.add('closed');
                mainContent.classList.add('sidebar-closed');
            }
        });
        
        // Sidebar navigation
        document.querySelectorAll('.sidebar-menu a[data-section]').forEach(a => {
            a.addEventListener('click', function(e){
                e.preventDefault();
                document.querySelectorAll('.sidebar-menu a').forEach(x=>x.classList.remove('active'));
                this.classList.add('active');
                const id = this.getAttribute('data-section');
                document.querySelectorAll('.content-section').forEach(sec=>sec.style.display='none');
                const target = document.getElementById(id);
                if (target) target.style.display='block';
                if (id === 'messages') { 
                    initializeChatSystem();
                    // Clear badge when opening messages
                    const badge = document.getElementById('messagesBadge');
                    if (badge) badge.style.display = 'none';
                }
                if (id === 'friends') { loadAcceptedFriends(); loadFriendRequests(); }
                if (id === 'groups') { 
                    loadGroups(); 
                    updateGroupsBadge(); // Clear groups badge
                }
                if (id === 'favorites') { loadFavorites(); }
            });
        });
        
        // Clear the session time when user logs out
        document.querySelector('.logout-btn').addEventListener('click', function() {
            localStorage.removeItem('sessionStartTime');
        });

        // Track online users locally
        let ONLINE_USERS = new Set();
        
        // Socket.IO client
        const socket = io();
        socket.on('connect', () => {
            console.log('Connected to realtime server');
        });
        socket.on('connected', (data) => {
            console.log('Joined room as user', data.user_id);
            // Add self to online users
            ONLINE_USERS.add(data.user_id);
        });
        
        socket.on('presence', (data) => {
            // Update online users count but we need individual user IDs
            // This is handled by user_status_update events
        });
        socket.on('friend_request', (payload) => {
            // refresh friend requests list
            loadFriendRequests();
        });
        socket.on('friend_request_update', (payload) => {
            loadFriendRequests();
            loadAcceptedFriends();
            loadConversations();
        });
        socket.on('new_message', (msg) => {
            // Append all messages when in the correct chat (both sent and received)
            if (currentChatUserId && (String(msg.from) === String(currentChatUserId) || String(msg.to) === String(currentChatUserId))) {
                appendMessage({
                    id: msg.id || Date.now(),
                    from: msg.from,
                    to: msg.to,
                    content: msg.content,
                    message_type: msg.message_type,
                    file_url: msg.file_url,
                    file_name: msg.file_name,
                    file_size: msg.file_size,
                    timestamp: msg.created_at || Date.now()
                });
            }
            
            // Show notification for received messages (not from self)
            if (String(msg.from) !== String(window._selfId)) {
                showMessageNotification(msg);
                updateMessagesBadge();
                // Update unread count for sender's conversation
                const conv = conversations.find(c => String(c[0]) === String(msg.from));
                if (conv) {
                    conv[3] = (conv[3] || 0) + 1; // Increment unread count
                    renderConversations();
                }
            }
            
            // Refresh conversations and stats
            loadConversations();
            loadMessageStats();
        });

        socket.on('unseen_update', () => { loadMessageStats(); });
        socket.on('user_status_update', (data) => {
            updateUserStatus(data.user_id, data.is_online);
            // Update ONLINE_USERS set
            if (data.is_online) {
                ONLINE_USERS.add(data.user_id);
            } else {
                ONLINE_USERS.delete(data.user_id);
            }

        });
        socket.on('message_blocked', (data) => {
            showNotification('warning', 'Message Blocked', data.message || 'This user has blocked you');
        });
        
        socket.on('group_added', (data) => {
            showNotification('success', 'Added to Group', data.message);
            loadGroups(); // Refresh groups list
            updateGroupsBadge();
        });
        
        socket.on('group_member_joined', (data) => {
            showNotification('info', 'Group Update', `${data.username} joined ${data.group_name}`);
            if (currentGroupId === data.group_id) {
                loadGroupMessages(data.group_id);
            }
            updateGroupsBadge(true);
        });
        
        socket.on('group_member_left', (data) => {
            showNotification('info', 'Group Update', `${data.username} left ${data.group_name}`);
            if (currentGroupId === data.group_id) {
                loadGroupMessages(data.group_id);
            }
            updateGroupsBadge(true);
        });
        
        socket.on('friend_request_received', (data) => {
            showNotification('info', 'Friend Request', `${data.from_username} sent you a friend request`);
            loadFriendRequests();
        });
        
        socket.on('friend_request_accepted', (data) => {
            showNotification('success', 'Friend Added', `${data.username} accepted your friend request`);
            loadAcceptedFriends();
            loadConversations();
        });
        
        socket.on('group_kicked', (data) => {
            showNotification('warning', 'Removed from Group', data.message);
            loadGroups(); // Refresh groups list
            // Close group chat if it's open
            if (currentGroupId === data.group_id) {
                document.getElementById('groupChatModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                currentGroupId = null;
            }
        });
        
        socket.on('group_promoted', (data) => {
            showNotification('success', 'Promoted to Admin', data.message);
            loadGroups(); // Refresh groups list to show new role
        });
        
        socket.on('group_demoted', (data) => {
            showNotification('info', 'Role Changed', data.message);
            loadGroups(); // Refresh groups list to show new role
        });
        
        socket.on('group_settings_updated', (data) => {
            showNotification('info', 'Group Updated', data.message);
            loadGroups(); // Refresh groups list
            // Update group chat title if it's open
            if (currentGroupId === data.group_id) {
                document.getElementById('groupChatTitle').textContent = data.name;
            }
        });

        // Friend requests UI
        function loadFriendRequests() {
            fetch('/get-friend-requests').then(r=>r.json()).then(d=>{
                const container = document.getElementById('frList');
                const countEl = document.getElementById('requestCount');
                
                if (!d.success) { 
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Failed to load requests</div>'; 
                    countEl.textContent = '0';
                    return; 
                }
                
                countEl.textContent = d.requests.length;
                
                if (!d.requests.length) { 
                    container.innerHTML = '<div style="text-align:center; padding:40px; color:#64748b;"><i class="fas fa-inbox" style="font-size:2rem; margin-bottom:12px; opacity:0.3;"></i><div>No pending requests</div></div>'; 
                    return; 
                }
                
                container.innerHTML = d.requests.map(r=>`
                    <div class="request-item">
                        <div class="request-user">
                            <div class="request-avatar">${r[1].charAt(0).toUpperCase()}</div>
                            <div class="request-info">
                                <h4>${r[1]}</h4>
                                <p>Wants to be your friend</p>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="accept-btn" data-id="${r[0]}" data-act="accept">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="reject-btn" data-id="${r[0]}" data-act="reject">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                `).join('');
                
                document.querySelectorAll('#frList button').forEach(btn=>{
                    btn.addEventListener('click', function(){
                        const id = this.getAttribute('data-id');
                        const action = this.getAttribute('data-act');
                        this.disabled = true;
                        this.innerHTML = action === 'accept' ? '<i class="fas fa-spinner fa-spin"></i> Accepting...' : '<i class="fas fa-spinner fa-spin"></i> Declining...';
                        
                        fetch('/respond-friend-request', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ request_id:id, action })})
                            .then(r=>r.json()).then(d=>{ 
                                if(d.success) {
                                    loadFriendRequests(); 
                                    loadAcceptedFriends();
                                    loadConversations();
                                    updateExistingFriends();
                                    showNotification('success', action === 'accept' ? 'Friend Added' : 'Request Declined', 
                                        action === 'accept' ? `You are now friends with ${r[1]}` : `Friend request declined`);
                                } else {
                                    showNotification('error', 'Action Failed', d.message || 'Failed to respond to request');
                                    this.disabled = false;
                                }
                            });
                    });
                });
            });
        }
        loadFriendRequests();
        updateExistingFriends();

        // Load accepted friends
        function loadAcceptedFriends() {
            fetch('/friends/accepted').then(r=>r.json()).then(d=>{
                const box = document.getElementById('acceptedFriendsList');
                if (!d.success) { 
                    box.innerHTML = '<p style="color:#6c757d; text-align:center; padding:20px;">Failed to load friends.</p>'; 
                    return; 
                }
                if (!d.friends.length) { 
                    box.innerHTML = '<p style="color:#6c757d; text-align:center; padding:20px;">No friends yet. Send friend requests to connect!</p>'; 
                    return; 
                }
                // Update friend counts in friends section only
                const onlineFriends = d.friends.filter(f => f[2]).length;
                
                // Update stats
                document.getElementById('friendsOnlineCount').textContent = onlineFriends;
                document.getElementById('friendsTotalCount').textContent = d.friends.length;
                
                box.innerHTML = d.friends.map(f=>{
                    const isOnline = f[2] || false;
                    const statusText = isOnline ? 'Online' : 'Offline';
                    const profilePicture = f[3] || null;
                    return `
                    <div class="friend-card" data-username="${f[1]}" data-id="${f[0]}">
                        <div class="friend-card-menu">
                            <button class="friend-menu-btn" onclick="toggleFriendMenu(event, '${f[1]}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="friend-dropdown" id="friendMenu-${f[1]}">
                                <button class="friend-dropdown-item" onclick="muteFriend('${f[1]}')">
                                    <i class="fas fa-volume-mute"></i> Mute
                                </button>
                                <button class="friend-dropdown-item danger" onclick="removeFriend('${f[1]}')">
                                    <i class="fas fa-user-minus"></i> remove
                                </button>
                                <button class="friend-dropdown-item danger" id="blockBtn-${f[1]}" onclick="toggleBlockFriend('${f[1]}')">
                                    <i class="fas fa-ban"></i> <span id="blockText-${f[1]}">Block</span>
                                </button>
                            </div>
                        </div>
                        <div class="friend-card-avatar">
                            ${profilePicture ? `<img src="${profilePicture}" alt="${f[1]}" />` : f[1].charAt(0).toUpperCase()}
                            <div class="friend-status-dot ${isOnline ? 'online' : 'offline'}"></div>
                        </div>
                        <h4>${f[1]}</h4>
                        <p>${statusText}</p>
                        <button class="chat-friend-btn" onclick="startChatWith('${f[1]}')">
                            <i class="fas fa-comment"></i> Start Chat
                        </button>
                    </div>
                    `;
                }).join('');
                
                // Check block status for each friend
                d.friends.forEach(f => {
                    fetch(`/users/blocked-status?user_id=${f[0]}`)
                        .then(r => r.json())
                        .then(data => {
                            const blockBtn = document.getElementById(`blockBtn-${f[1]}`);
                            if (blockBtn && data.success) {
                                if (data.is_blocked) {
                                    blockBtn.innerHTML = '<i class="fas fa-user-check"></i> <span id="blockText-${f[1]}">Unblock</span>';
                                } else {
                                    blockBtn.innerHTML = '<i class="fas fa-ban"></i> <span id="blockText-${f[1]}">Block</span>';
                                }
                            }
                        })
                        .catch(() => {});
                });
            }).catch(e => {
                console.error('Error loading friends:', e);
                document.getElementById('acceptedFriendsList').innerHTML = '<p style="color:#dc3545; text-align:center; padding:20px;">Error loading friends. Please refresh.</p>';
            });
        }
        loadAcceptedFriends();

        // Start chat function
        function startChatWith(username) {
            // Switch to messages section
            document.querySelectorAll('.sidebar-menu a').forEach(x=>x.classList.remove('active'));
            document.querySelector('.sidebar-menu a[data-section="messages"]').classList.add('active');
            document.querySelectorAll('.content-section').forEach(sec=>sec.style.display='none');
            document.getElementById('messages').style.display='block';
            initializeChatSystem();
            // Open chat with the user after loading conversations
            setTimeout(() => {
                const chatItem = document.querySelector(`[data-username="${username}"]`);
                if (chatItem) {
                    chatItem.click();
                }
            }, 500);
        }

        // Notification system
        function showNotification(type, title, message) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${iconMap[type] || iconMap.info}"></i>
                </div>
                <div class="notification-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 400);
            });
            
            setTimeout(() => {
                if (container.contains(notification)) {
                    notification.classList.remove('show');
                    setTimeout(() => container.removeChild(notification), 400);
                }
            }, 5000);
        }
        
        // Track existing friends to prevent duplicate requests
        let existingFriends = new Set();
        
        function updateExistingFriends() {
            fetch('/friends/accepted').then(r=>r.json()).then(d=>{
                if (d.success) {
                    existingFriends = new Set(d.friends.map(f => f[1].toLowerCase()));
                }
            });
        }
        
        document.getElementById('sendFrBtn').addEventListener('click', function(){
            const username = document.getElementById('frUsername').value.trim();
            if (!username) {
                showNotification('warning', 'Invalid Input', 'Please enter a username');
                return;
            }
            
            if (existingFriends.has(username.toLowerCase())) {
                showNotification('warning', 'Already Friends', `You are already friends with ${username}`);
                return;
            }
            
            if (username.toLowerCase() === window._selfUsername.toLowerCase()) {
                showNotification('error', 'Invalid Request', 'You cannot send a friend request to yourself');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            fetch('/send-friend-request', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username })})
                .then(r=>r.json()).then(d=>{
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-paper-plane"></i> Send Request';
                    
                    if (!d.success) {
                        showNotification('error', 'Request Failed', d.message || 'Failed to send friend request');
                    } else {
                        showNotification('success', 'Request Sent', `Friend request sent to ${username}`);
                        document.getElementById('frUsername').value = '';
                    }
                });
        });



        // Overlay controls
        const chatOverlay = document.getElementById('chatOverlay');
        document.getElementById('overlayClose').addEventListener('click', ()=> chatOverlay.classList.remove('active'));
        function openOverlay() { chatOverlay.classList.add('active'); setTimeout(()=>document.getElementById('overlayInput').focus(), 50); }
        document.getElementById('overlaySend').addEventListener('click', function(){
            const input = document.getElementById('overlayInput');
            const txt = input.value.trim();
            const to = window._currentChatUserId;
            if (!txt || !to) return;
            socket.emit('send_message', { to, content: txt });
            input.value = '';
        });
        document.getElementById('overlayInput').addEventListener('keydown', function(e){
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('overlaySend').click(); }
        });
        // Disable overlay opening
        // document.getElementById('chatHeader').addEventListener('click', function(){ if (window._currentChatUserId) openOverlay(); });
        // document.getElementById('chatWindow').addEventListener('dblclick', function(){ if (window._currentChatUserId) openOverlay(); });

        // Modern Chat Management System
        let currentChatUser = null;
        let currentChatUserId = null;
        let conversations = [];
        let filteredConversations = [];
        let currentFilter = 'all';
        
        // Load conversations for new chat system
        function loadConversations() {
            fetch('/friends/accepted').then(r=>r.json()).then(d=>{
                const container = document.getElementById('conversationsList');
                if (!d.success) { 
                    container.innerHTML = '<div class="conversation-item" style="justify-content:center; color:#ef4444;">Failed to load conversations</div>'; 
                    return; 
                }
                
                // Map friends to conversation format: [id, username, isOnline, unreadCount, profilePicture]
                conversations = (d.friends || []).map(f => [f[0], f[1], f[2], f[4] || 0, f[3]]);
                filteredConversations = [...conversations];
                
                if (!conversations.length) { 
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px 20px; color:#64748b;">
                            <i class="fas fa-comments" style="font-size:3rem; margin-bottom:16px; opacity:0.3;"></i>
                            <div style="font-size:1.1rem; margin-bottom:8px;">No conversations yet</div>
                            <div style="font-size:0.9rem;">Add friends to start chatting</div>
                        </div>
                    `; 
                    return; 
                }
                
                renderConversations();
            }).catch(e => {
                console.error('Error loading conversations:', e);
                document.getElementById('conversationsList').innerHTML = '<div style="color:#ef4444; text-align:center; padding:20px;">Error loading conversations</div>';
            });
        }
        
        // Update user status in real-time
        function updateUserStatus(userId, isOnline) {
            // Update conversations list
            const conv = conversations.find(c => String(c[0]) === String(userId));
            if (conv) {
                conv[2] = isOnline;
                renderConversations();
            }
            
            // Update current chat header if it's the same user
            if (String(currentChatUserId) === String(userId)) {
                document.getElementById('currentChatStatus').textContent = isOnline ? 'Online' : 'Offline';
            }
            
            // Update friends list
            loadAcceptedFriends();
        }
        
        // Render conversations list
        function renderConversations() {
            const container = document.getElementById('conversationsList');
            const searchTerm = document.getElementById('chatSearchInput').value.toLowerCase();
            const isCollapsed = chatSidebar && chatSidebar.classList.contains('collapsed');
            
            let filtered = conversations.filter(conv => {
                const matchesSearch = conv[1].toLowerCase().includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || 
                    (currentFilter === 'online' && conv[2]) ||
                    (currentFilter === 'unread' && conv[3] > 0);
                return matchesSearch && matchesFilter;
            });
            
            if (!filtered.length) {
                if (isCollapsed) {
                    container.innerHTML = '';
                } else {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">No conversations found</div>';
                }
                return;
            }
            
            container.innerHTML = filtered.map(conv => {
                const [id, username, isOnline, unreadCount, profilePicture] = conv;
                const isActive = currentChatUser === username;
                
                if (isCollapsed) {
                    return `
                        <div class="conversation-item ${isActive ? 'active' : ''}" data-username="${username}" data-id="${id}" title="${username} (${isOnline ? 'Online' : 'Offline'})">
                            <div class="conversation-avatar">
                                ${profilePicture ? `<img src="${profilePicture}" alt="${username}" />` : username.charAt(0).toUpperCase()}
                                <div class="${isOnline ? 'online-indicator' : 'offline-indicator'}"></div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="conversation-item ${isActive ? 'active' : ''}" data-username="${username}" data-id="${id}">
                            <div class="conversation-avatar">
                                ${profilePicture ? `<img src="${profilePicture}" alt="${username}" />` : username.charAt(0).toUpperCase()}
                                <div class="${isOnline ? 'online-indicator' : 'offline-indicator'}"></div>
                            </div>
                            <div class="conversation-info">
                                <div class="conversation-name">${username}</div>
                                <div class="conversation-preview">${isOnline ? 'Online' : 'Offline'}</div>
                            </div>
                            <div class="conversation-meta">
                                <div class="conversation-time">now</div>
                                ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            // Add click handlers
            container.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const userId = this.getAttribute('data-id');
                    openChat(username, userId);
                });
            });
        }
        
        // Open chat with user
        function openChat(username, userId) {
            currentChatUser = username;
            currentChatUserId = userId;
            
            // Update active conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-username="${username}"]`).classList.add('active');
            
            // Show chat container and hide welcome
            document.getElementById('chatWelcome').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            
            // Update chat header
            const userConv = conversations.find(c => String(c[0]) === String(userId));
            const isOnline = userConv ? userConv[2] : false;
            const profilePicture = userConv ? userConv[4] : null;
            
            const chatAvatar = document.getElementById('currentChatAvatar');
            if (profilePicture) {
                chatAvatar.innerHTML = `<img src="${profilePicture}" alt="${username}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;" />`;
            } else {
                chatAvatar.textContent = username.charAt(0).toUpperCase();
            }
            
            document.getElementById('currentChatName').textContent = username;
            document.getElementById('currentChatStatus').textContent = isOnline ? 'Online' : 'Offline';
            
            // Check block and mute status
            Promise.all([
                fetch(`/users/blocked-status?user_id=${userId}`).then(r => r.json()),
                fetch(`/users/muted-status?user_id=${userId}`).then(r => r.json())
            ]).then(([blockData, muteData]) => {
                const blockBtn = document.getElementById('blockUserBtn');
                const muteBtn = document.getElementById('muteBtn');
                
                if (blockData.success) {
                    if (blockData.is_blocked) {
                        blockBtn.innerHTML = '<i class="fas fa-user-check"></i> Unblock User';
                    } else {
                        blockBtn.innerHTML = '<i class="fas fa-ban"></i> Block User';
                    }
                }
                
                if (muteData.success) {
                    if (muteData.is_muted) {
                        muteBtn.innerHTML = '<i class="fas fa-volume-up"></i> Unmute';
                    } else {
                        muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Mute';
                    }
                }
            }).catch(() => {});
            
            // Load chat history
            loadChatHistory(userId);
            
            // Focus message input if not blocked
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                if (!messageInput.disabled) {
                    messageInput.focus();
                }
            }, 100);
            
            // Save current chat
            localStorage.setItem('lastChatUser', username);
        }
        
        // Load chat history
        function loadChatHistory(userId) {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Loading messages...</div>';
            
            fetch(`/messages/history?with_user_id=${userId}`)
                .then(r => r.json())
                .then(data => {
                    messagesList.innerHTML = '';
                    if (data.success && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            appendMessage({
                                id: msg.id,
                                from: msg.sender_id,
                                to: msg.receiver_id,
                                content: msg.content,
                                message_type: msg.message_type,
                                file_url: msg.file_url,
                                file_name: msg.file_name,
                                file_size: msg.file_size,
                                timestamp: msg.created_at || Date.now()
                            });
                        });
                    } else {
                        messagesList.innerHTML = '<div style="text-align:center; padding:40px; color:#64748b;">No messages yet. Start the conversation!</div>';
                    }
                    // Always scroll to bottom when opening chat
                    setTimeout(() => {
                        scrollToBottom();
                    }, 200);
                    
                    // Mark messages as seen
                    fetch('/messages/mark-seen', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ other_id: userId })
                    }).then(() => {
                        updateMessagesBadge();
                        // Clear unread count for this conversation
                        const conv = conversations.find(c => String(c[0]) === String(userId));
                        if (conv) {
                            conv[3] = 0; // Reset unread count
                            renderConversations();
                        }
                    }).catch(() => {});
                })
                .catch(e => {
                    console.error('Error loading chat history:', e);
                    messagesList.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">Error loading messages</div>';
                });
        }
        
        // Append message to chat
        function appendMessage(message) {
            const messagesList = document.getElementById('messagesList');
            if (!messagesList) return;
            
            const isOwn = String(message.from) === String(window._selfId);
            
            const messageEl = document.createElement('div');
            messageEl.className = `message-bubble ${isOwn ? 'sent' : 'received'}`;
            messageEl.setAttribute('data-message-id', message.id);
            
            const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let content = '';
            if (message.message_type === 'file' && message.file_url) {
                const fileSize = message.file_size ? `(${(message.file_size / 1024).toFixed(1)} KB)` : '';
                const fileName = message.file_name || 'File';
                content = `
                    <div class="file-message" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <i class="fas fa-file" style="font-size: 1.2rem;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${fileName}</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">${fileSize}</div>
                        </div>
                        <a href="${message.file_url}" download="${fileName}" style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; color: inherit; text-decoration: none; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>
                `;
                if (message.content && message.content !== `Shared a file: ${message.file_name}`) {
                    content += `<div style="margin-top: 8px;">${escapeHtml(message.content)}</div>`;
                }
            } else {
                content = `<div class="message-content">${escapeHtml(message.content)}</div>`;
            }
            
            messageEl.innerHTML = `
                <button class="react-btn" onclick="showReactionPicker(${message.id}, event)" title="React"></button>
                ${content}
                <div class="message-time">${time}</div>
            `;
            
            messagesList.appendChild(messageEl);
            scrollToBottom();
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Scroll to bottom of messages
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 10);
            }
        }
        
        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChatUserId) return;
            
            // Immediately show the message in UI
            appendMessage({
                id: Date.now(),
                from: window._selfId,
                to: currentChatUserId,
                content: content,
                timestamp: Date.now()
            });
            
            // Emit message via socket
            socket.emit('send_message', {
                to: currentChatUserId,
                content: content
            });
            
            // Clear input
            input.value = '';
            adjustTextareaHeight(input);
        }
        
        // Auto-resize textarea
        function adjustTextareaHeight(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // Initialize chat system when messages section is opened
        function initializeChatSystem() {
            loadConversations();
            
            // Restore last chat if exists
            const lastChat = localStorage.getItem('lastChatUser');
            if (lastChat) {
                setTimeout(() => {
                    const chatItem = document.querySelector(`[data-username="${lastChat}"]`);
                    if (chatItem) {
                        chatItem.click();
                    }
                }, 300);
            }
        }
        
        // Dark theme functionality
        document.getElementById('darkTheme').addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            }
        });
        
        document.getElementById('lightTheme').addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
            }
        });
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.getElementById('darkTheme').checked = true;
            document.body.classList.add('dark-theme');
        }
        
        // Password change functionality
        document.getElementById('changePasswordBtn').addEventListener('click', function() {
            document.getElementById('passwordModal').style.display = 'block';
        });
        
        document.getElementById('cancelPasswordBtn').addEventListener('click', function() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });
        
        document.getElementById('cancelPasswordBtn2').addEventListener('click', function() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });
        
        document.getElementById('updatePasswordBtn').addEventListener('click', function() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (!current || !newPass || !confirm) {
                alert('Please fill all fields');
                return;
            }
            
            if (newPass !== confirm) {
                alert('New passwords do not match');
                return;
            }
            
            fetch('/change-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    current_password: current,
                    new_password: newPass
                })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    alert('Password changed successfully!');
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert(d.message || 'Failed to change password');
                }
            })
            .catch(() => alert('Error changing password'));
        });

        // Chat System Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Search functionality
            const searchInput = document.getElementById('chatSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const hasValue = this.value.length > 0;
                    clearSearchBtn.style.display = hasValue ? 'flex' : 'none';
                    renderConversations();
                });
            }
            
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    this.style.display = 'none';
                    renderConversations();
                });
            }
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    renderConversations();
                });
            });
            
            // Sidebar toggle
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const chatSidebar = document.getElementById('chatSidebar');
            
            if (toggleSidebarBtn && chatSidebar) {
                toggleSidebarBtn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        // Mobile: hide sidebar completely
                        chatSidebar.classList.remove('show');
                    } else {
                        // Desktop: collapse/expand
                        chatSidebar.classList.toggle('collapsed');
                        const icon = this.querySelector('i');
                        const headerIcon = toggleConversationsBtn ? toggleConversationsBtn.querySelector('i') : null;
                        if (chatSidebar.classList.contains('collapsed')) {
                            icon.className = 'fas fa-chevron-right';
                            if (headerIcon) headerIcon.className = 'fas fa-chevron-right';
                        } else {
                            icon.className = 'fas fa-chevron-left';
                            if (headerIcon) headerIcon.className = 'fas fa-bars';
                        }
                        // Re-render conversations to show/hide user info
                        renderConversations();
                    }
                });
            }
            
            // Mobile chat toggle - only create if in messages section
            let mobileChatToggle = null;
            if (document.getElementById('messages')) {
                mobileChatToggle = document.createElement('button');
                mobileChatToggle.className = 'mobile-chat-toggle';
                mobileChatToggle.innerHTML = '<i class="fas fa-comments"></i>';
                mobileChatToggle.title = 'Toggle Chat Sidebar';
                mobileChatToggle.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
                document.body.appendChild(mobileChatToggle);
                
                mobileChatToggle.addEventListener('click', function() {
                    if (chatSidebar) {
                        chatSidebar.classList.toggle('show');
                    }
                });
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768 && chatSidebar &&
                        !chatSidebar.contains(e.target) && 
                        !mobileChatToggle.contains(e.target)) {
                        chatSidebar.classList.remove('show');
                    }
                });
            }
            
            // Message input
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    adjustTextareaHeight(this);
                    if (sendBtn) {
                        sendBtn.disabled = !this.value.trim();
                    }
                });
                
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (this.value.trim()) {
                            sendMessage();
                        }
                    }
                });
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    sendMessage();
                });
            }
            
            // Emoji picker
            const emojiBtn = document.getElementById('emojiBtn');
            const emojiPicker = document.getElementById('emojiPicker');
            
            if (emojiBtn && emojiPicker) {
                emojiBtn.addEventListener('click', function() {
                    emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
                });
                
                emojiPicker.addEventListener('click', function(e) {
                    if (e.target.classList.contains('emoji-item')) {
                        messageInput.value += e.target.textContent;
                        messageInput.focus();
                        adjustTextareaHeight(messageInput);
                        emojiPicker.style.display = 'none';
                    }
                });
            }
            
            // File attachment
            const attachBtn = document.getElementById('attachBtn');
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');
            
            if (attachBtn && fileUpload) {
                attachBtn.addEventListener('click', function() {
                    fileUpload.style.display = fileUpload.style.display === 'none' ? 'block' : 'none';
                });
            }
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    const files = Array.from(this.files);
                    files.forEach(file => {
                        handleFileUpload(file);
                    });
                    this.value = ''; // Reset input
                });
            }
            
            // Chat menu dropdown
            const chatMenuBtn = document.getElementById('chatMenuBtn');
            const chatDropdownMenu = document.getElementById('chatDropdownMenu');
            
            if (chatMenuBtn && chatDropdownMenu) {
                chatMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    chatDropdownMenu.classList.toggle('show');
                });
                
                document.addEventListener('click', function() {
                    chatDropdownMenu.classList.remove('show');
                });
                
                // Dropdown menu actions
                const muteBtn = document.getElementById('muteBtn');
                const clearChatBtn = document.getElementById('clearChatBtn');
                const blockUserBtn = document.getElementById('blockUserBtn');
                
                if (muteBtn) {
                    muteBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (currentChatUser && currentChatUserId) {
                            const isMuted = this.textContent.includes('Unmute');
                            const action = isMuted ? 'unmute' : 'mute';
                            const endpoint = isMuted ? '/users/unmute' : '/users/mute';
                            
                            fetch(endpoint, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ user_id: currentChatUserId })
                            })
                            .then(r => r.json())
                            .then(d => {
                                if (d.success) {
                                    if (isMuted) {
                                        this.innerHTML = '<i class="fas fa-volume-mute"></i> Mute';
                                        showNotification('success', 'User Unmuted', `${currentChatUser} has been unmuted`);
                                    } else {
                                        this.innerHTML = '<i class="fas fa-volume-up"></i> Unmute';
                                        showNotification('info', 'User Muted', `${currentChatUser} has been muted`);
                                    }
                                } else {
                                    showNotification('error', 'Action Failed', d.message || `Failed to ${action} user`);
                                }
                            })
                            .catch(() => {
                                showNotification('error', 'Action Failed', `Failed to ${action} user`);
                            });
                        }
                        chatDropdownMenu.classList.remove('show');
                    });
                }
                
                if (clearChatBtn) {
                    clearChatBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (currentChatUser) {
                            document.getElementById('messagesList').innerHTML = '<div style="text-align:center; padding:40px; color:#64748b;">Clearing chat...</div>';
                            
                            fetch('/messages/clear', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ other_user_id: currentChatUserId })
                            })
                            .then(r => r.json())
                            .then(d => {
                                if (d.success) {
                                    document.getElementById('messagesList').innerHTML = '<div style="text-align:center; padding:40px; color:#64748b;">Chat cleared from your view. Start a new conversation!</div>';
                                    showNotification('success', 'Chat Cleared', `Chat history with ${currentChatUser} cleared from your view only`);
                                    loadMessageStats();
                                } else {
                                    showNotification('error', 'Clear Failed', 'Failed to clear chat history');
                                    loadChatHistory(currentChatUserId);
                                }
                            })
                            .catch(() => {
                                showNotification('error', 'Clear Failed', 'Failed to clear chat history');
                                loadChatHistory(currentChatUserId);
                            });
                        }
                        chatDropdownMenu.classList.remove('show');
                    });
                }
                
                if (blockUserBtn) {
                    blockUserBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (currentChatUser && currentChatUserId) {
                            const isBlocked = this.textContent.includes('Unblock');
                            const action = isBlocked ? 'unblock' : 'block';
                            const endpoint = isBlocked ? '/users/unblock' : '/users/block';
                            
                            fetch(endpoint, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ user_id: currentChatUserId })
                            })
                            .then(r => r.json())
                            .then(d => {
                                if (d.success) {
                                    if (isBlocked) {
                                        this.innerHTML = '<i class="fas fa-ban"></i> Block User';
                                        showNotification('success', 'User Unblocked', `${currentChatUser} has been unblocked`);
                                    } else {
                                        this.innerHTML = '<i class="fas fa-user-check"></i> Unblock User';
                                        showNotification('warning', 'User Blocked', `${currentChatUser} has been blocked. They cannot send you messages.`);
                                    }
                                    loadConversations();
                                } else {
                                    showNotification('error', 'Action Failed', d.message || `Failed to ${action} user`);
                                }
                            })
                            .catch(() => {
                                showNotification('error', 'Action Failed', `Failed to ${action} user`);
                            });
                        }
                        chatDropdownMenu.classList.remove('show');
                    });
                }
            }
            
            // Toggle conversations button
            const toggleConversationsBtn = document.getElementById('toggleConversationsBtn');
            if (toggleConversationsBtn && chatSidebar) {
                toggleConversationsBtn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        chatSidebar.classList.toggle('show');
                    } else {
                        chatSidebar.classList.toggle('collapsed');
                        const icon = this.querySelector('i');
                        const sidebarIcon = toggleSidebarBtn ? toggleSidebarBtn.querySelector('i') : null;
                        if (chatSidebar.classList.contains('collapsed')) {
                            icon.className = 'fas fa-chevron-right';
                            if (sidebarIcon) sidebarIcon.className = 'fas fa-chevron-right';
                        } else {
                            icon.className = 'fas fa-bars';
                            if (sidebarIcon) sidebarIcon.className = 'fas fa-chevron-left';
                        }
                        // Re-render conversations to show/hide user info
                        renderConversations();
                    }
                });
            }
            
            // Header action buttons
            const callBtn = document.getElementById('callBtn');
            const videoCallBtn = document.getElementById('videoCallBtn');
            const searchMessagesBtn = document.getElementById('searchMessagesBtn');
            const chatInfoBtn = document.getElementById('chatInfoBtn');
            
            if (callBtn) {
                callBtn.addEventListener('click', function() {
                    if (currentChatUserId) {
                        startCall(currentChatUserId, 'audio');
                    } else {
                        showNotification('warning', 'No Chat Selected', 'Please select a chat first');
                    }
                });
            }
            
            if (videoCallBtn) {
                videoCallBtn.addEventListener('click', function() {
                    if (currentChatUserId) {
                        startCall(currentChatUserId, 'video');
                    } else {
                        showNotification('warning', 'No Chat Selected', 'Please select a chat first');
                    }
                });
            }
            
            if (searchMessagesBtn) {
                searchMessagesBtn.addEventListener('click', function() {
                    alert('Message search feature coming soon!');
                });
            }
            
            if (chatInfoBtn) {
                chatInfoBtn.addEventListener('click', function() {
                    alert('Chat info feature coming soon!');
                });
            }
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (chatSidebar) {
                    if (window.innerWidth > 768) {
                        chatSidebar.classList.remove('show');
                        if (mobileChatToggle) mobileChatToggle.style.display = 'none';
                    } else {
                        chatSidebar.classList.remove('collapsed');
                        if (mobileChatToggle) mobileChatToggle.style.display = 'flex';
                        // Reset toggle icon
                        if (toggleSidebarBtn) {
                            const icon = toggleSidebarBtn.querySelector('i');
                            if (icon) icon.className = 'fas fa-chevron-left';
                        }
                        // Re-render conversations for mobile
                        renderConversations();
                    }
                }
            });
        });
        
        // Friend menu functions
        function toggleFriendMenu(event, username) {
            event.stopPropagation();
            const menu = document.getElementById(`friendMenu-${username}`);
            const allMenus = document.querySelectorAll('.friend-dropdown');
            
            allMenus.forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
        }
        
        function muteFriend(username) {
            // Get user ID from friend card
            const friendCard = document.querySelector(`[data-username="${username}"]`);
            const userId = friendCard ? friendCard.getAttribute('data-id') : null;
            
            if (!userId) {
                showNotification('error', 'Mute Failed', 'Unable to find user');
                return;
            }
            
            fetch('/users/mute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: userId })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('info', 'Friend Muted', `${username} has been muted`);
                } else {
                    showNotification('error', 'Mute Failed', d.message || 'Failed to mute user');
                }
            })
            .catch(() => {
                showNotification('error', 'Mute Failed', 'Failed to mute user');
            });
            
            document.getElementById(`friendMenu-${username}`).classList.remove('show');
        }
        
        function removeFriend(username) {
            if (confirm(`Are you sure you want to unfriend ${username}?`)) {
                fetch('/remove-friend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: username })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        showNotification('success', 'Friend Removed', `${username} has been unfriended`);
                        loadAcceptedFriends();
                        loadConversations();
                        updateExistingFriends();
                    } else {
                        showNotification('error', 'Remove Failed', d.message || 'Failed to remove friend');
                    }
                })
                .catch(() => {
                    showNotification('error', 'Remove Failed', 'Failed to remove friend');
                });
            }
            document.getElementById(`friendMenu-${username}`).classList.remove('show');
        }
        
        function toggleBlockFriend(username) {
            const friendCard = document.querySelector(`[data-username="${username}"]`);
            const userId = friendCard ? friendCard.getAttribute('data-id') : null;
            
            if (!userId) {
                showNotification('error', 'Action Failed', 'Unable to find user');
                return;
            }
            
            // Check current block status
            fetch(`/users/blocked-status?user_id=${userId}`)
                .then(r => r.json())
                .then(statusData => {
                    if (!statusData.success) {
                        showNotification('error', 'Action Failed', 'Unable to check block status');
                        return;
                    }
                    
                    const isBlocked = statusData.is_blocked;
                    const action = isBlocked ? 'unblock' : 'block';
                    const endpoint = isBlocked ? '/users/unblock' : '/users/block';
                    const confirmMsg = isBlocked ? `Unblock ${username}?` : `Block ${username}?`;
                    
                    if (confirm(confirmMsg)) {
                        fetch(endpoint, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ user_id: userId })
                        })
                        .then(r => r.json())
                        .then(d => {
                            if (d.success) {
                                const msg = isBlocked ? 'Friend Unblocked' : 'Friend Blocked';
                                const type = isBlocked ? 'success' : 'warning';
                                showNotification(type, msg, `${username} has been ${action}ed`);
                                loadAcceptedFriends();
                                loadConversations();
                            } else {
                                showNotification('error', 'Action Failed', d.message || `Failed to ${action} user`);
                            }
                        })
                        .catch(() => {
                            showNotification('error', 'Action Failed', `Failed to ${action} user`);
                        });
                    }
                })
                .catch(() => {
                    showNotification('error', 'Action Failed', 'Unable to check block status');
                });
            
            document.getElementById(`friendMenu-${username}`).classList.remove('show');
        }
        
        // Member menu functions
        function toggleMemberMenu(event, memberId) {
            event.stopPropagation();
            const menu = document.getElementById(`memberMenu-${memberId}`);
            const allMenus = document.querySelectorAll('.member-dropdown');
            
            // Close all other menus
            allMenus.forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                }
            });
            
            // Toggle current menu
            menu.classList.toggle('show');
        }
        
        function kickMember(groupId, memberId, memberName) {
            // Close dropdown menu
            document.querySelectorAll('.member-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            if (!confirm(`Are you sure you want to remove ${memberName} from the group?`)) {
                return;
            }
            
            fetch(`/groups/${groupId}/kick-member`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ member_id: memberId })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Member Removed', d.message);
                    // Close modal and refresh
                    const modal = document.getElementById('groupMembersModal');
                    if (modal) {
                        document.body.removeChild(modal);
                        document.body.style.overflow = 'auto';
                    }
                    // Refresh group members
                    setTimeout(() => viewGroupMembers(groupId, 'Group'), 500);
                } else {
                    showNotification('error', 'Action Failed', d.message || 'Failed to remove member');
                }
            })
            .catch(() => {
                showNotification('error', 'Action Failed', 'Failed to remove member');
            });
        }
        
        function promoteMember(groupId, memberId, memberName) {
            // Close dropdown menu
            document.querySelectorAll('.member-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            if (!confirm(`Are you sure you want to promote ${memberName} to admin?`)) {
                return;
            }
            
            fetch(`/groups/${groupId}/promote-member`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ member_id: memberId })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Member Promoted', d.message);
                    // Close modal and refresh
                    const modal = document.getElementById('groupMembersModal');
                    if (modal) {
                        document.body.removeChild(modal);
                        document.body.style.overflow = 'auto';
                    }
                    // Refresh group members
                    setTimeout(() => viewGroupMembers(groupId, 'Group'), 500);
                } else {
                    showNotification('error', 'Action Failed', d.message || 'Failed to promote member');
                }
            })
            .catch(() => {
                showNotification('error', 'Action Failed', 'Failed to promote member');
            });
        }
        
        function demoteMember(groupId, memberId, memberName) {
            // Close dropdown menu
            document.querySelectorAll('.member-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            if (!confirm(`Are you sure you want to demote ${memberName} to member?`)) {
                return;
            }
            
            fetch(`/groups/${groupId}/demote-member`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ member_id: memberId })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Member Demoted', d.message);
                    // Close modal and refresh
                    const modal = document.getElementById('groupMembersModal');
                    if (modal) {
                        document.body.removeChild(modal);
                        document.body.style.overflow = 'auto';
                    }
                    // Refresh group members
                    setTimeout(() => viewGroupMembers(groupId, 'Group'), 500);
                } else {
                    showNotification('error', 'Action Failed', d.message || 'Failed to demote member');
                }
            })
            .catch(() => {
                showNotification('error', 'Action Failed', 'Failed to demote member');
            });
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.friend-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            document.querySelectorAll('.friend-dropdown-submenu').forEach(submenu => {
                submenu.classList.remove('show');
            });
        });
        
        // Profile picture upload functionality
        document.getElementById('uploadProfilePicBtn').addEventListener('click', function() {
            document.getElementById('profilePictureInput').click();
        });
        
        document.getElementById('profilePictureInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Reset the input to allow re-uploading the same file
            this.value = '';
            
            // Validate file size
            if (file.size > 5 * 1024 * 1024) {
                showNotification('error', 'File Too Large', 'Profile picture must be less than 5MB');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('error', 'Invalid File Type', 'Please select a JPG, PNG, GIF, or WebP image');
                return;
            }
            
            // Show loading state
            const uploadBtn = document.getElementById('uploadProfilePicBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            uploadBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('profile_picture', file);
            
            fetch('/upload-profile-picture', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Profile Updated', d.message || 'Profile picture uploaded successfully');
                    loadCurrentProfilePicture();
                } else {
                    showNotification('error', 'Upload Failed', d.message || 'Failed to upload profile picture');
                }
            })
            .catch((error) => {
                console.error('Upload error:', error);
                showNotification('error', 'Upload Failed', 'Network error occurred while uploading');
            })
            .finally(() => {
                // Restore button state
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            });
        });
        
        document.getElementById('removeProfilePicBtn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to remove your profile picture?')) return;
            
            // Show loading state
            const removeBtn = this;
            const originalText = removeBtn.innerHTML;
            removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
            removeBtn.disabled = true;
            
            fetch('/remove-profile-picture', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Profile Updated', d.message || 'Profile picture removed successfully');
                    // Reset to default avatar
                    const headerAvatar = document.querySelector('.user-avatar');
                    if (headerAvatar) {
                        headerAvatar.innerHTML = '{{ username[0].upper() }}';
                    }
                    const currentProfilePic = document.getElementById('currentProfilePic');
                    if (currentProfilePic) {
                        const currentSize = localStorage.getItem('dpSize') || 'small';
                        currentProfilePic.innerHTML = '{{ username[0].upper() }}';
                        currentProfilePic.className = `avatar profile-dp ${currentSize}`;
                    }
                    removeBtn.style.display = 'none';
                } else {
                    showNotification('error', 'Remove Failed', d.message || 'Failed to remove profile picture');
                }
            })
            .catch((error) => {
                console.error('Remove error:', error);
                showNotification('error', 'Remove Failed', 'Network error occurred while removing picture');
            })
            .finally(() => {
                // Restore button state
                removeBtn.innerHTML = originalText;
                removeBtn.disabled = false;
            });
        });
        
        // Load profile picture on page load
        function loadCurrentProfilePicture() {
            fetch('/get-profile-picture')
                .then(r => r.json())
                .then(d => {
                    if (d.success && d.profile_picture) {
                        // Update header avatar
                        const headerAvatar = document.querySelector('.user-avatar');
                        if (headerAvatar) {
                            headerAvatar.innerHTML = `<img src="${d.profile_picture}" alt="Profile Picture" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        }
                        
                        // Update settings profile picture
                        const currentProfilePic = document.getElementById('currentProfilePic');
                        if (currentProfilePic) {
                            const currentSize = localStorage.getItem('dpSize') || 'small';
                            currentProfilePic.innerHTML = `<img src="${d.profile_picture}" alt="Profile Picture" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
                            currentProfilePic.className = `avatar profile-dp ${currentSize}`;
                        }
                        
                        // Show remove button
                        const removeBtn = document.getElementById('removeProfilePicBtn');
                        if (removeBtn) {
                            removeBtn.style.display = 'flex';
                        }
                    } else {
                        // No profile picture, hide remove button
                        const removeBtn = document.getElementById('removeProfilePicBtn');
                        if (removeBtn) {
                            removeBtn.style.display = 'none';
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading profile picture:', error);
                });
        }
        
        // DP size change functionality
        document.getElementById('dpSizeSelect').addEventListener('change', function() {
            const size = this.value;
            const profilePic = document.getElementById('currentProfilePic');
            
            if (profilePic) {
                // Remove existing size classes
                profilePic.classList.remove('small', 'medium', 'large');
                // Add new size class
                profilePic.classList.add(size);
                
                // Save preference
                localStorage.setItem('dpSize', size);
                showNotification('success', 'Size Updated', `Profile picture size changed to ${size}`);
            }
        });
        
        // Load saved DP size
        function loadDpSize() {
            const savedSize = localStorage.getItem('dpSize') || 'small';
            const dpSelect = document.getElementById('dpSizeSelect');
            const profilePic = document.getElementById('currentProfilePic');
            
            if (dpSelect) {
                dpSelect.value = savedSize;
            }
            
            if (profilePic) {
                profilePic.classList.remove('small', 'medium', 'large');
                profilePic.classList.add(savedSize);
            }
        }
        
        // Load profile picture on page load
        loadCurrentProfilePicture();
        loadDpSize();
        
        // Go to profile function
        function goToProfile() {
            document.querySelectorAll('.sidebar-menu a').forEach(x=>x.classList.remove('active'));
            document.querySelector('.sidebar-menu a[data-section="settings"]').classList.add('active');
            document.querySelectorAll('.content-section').forEach(sec=>sec.style.display='none');
            document.getElementById('settings').style.display='block';
        }
        
        // Groups functionality
        let currentGroupId = null;
        
        function toggleGroupMenu(event, groupId) {
            event.stopPropagation();
            const menu = document.getElementById(`groupMenu-${groupId}`);
            const allMenus = document.querySelectorAll('.friend-dropdown');
            
            allMenus.forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
        }
        
        function toggleGroupSettingsSubmenu(event, groupId) {
            event.stopPropagation();
            event.preventDefault();
            
            const submenu = document.getElementById(`groupSettingsSubmenu-${groupId}`);
            if (!submenu) {
                console.error('Submenu not found:', `groupSettingsSubmenu-${groupId}`);
                return;
            }
            
            const allSubmenus = document.querySelectorAll('.friend-dropdown-submenu');
            
            // Close all other submenus
            allSubmenus.forEach(m => {
                if (m !== submenu) {
                    m.classList.remove('show');
                }
            });
            
            // Toggle current submenu
            submenu.classList.toggle('show');
            
            console.log('Submenu toggled:', submenu.classList.contains('show'));
        }
        
        function addFriendsToGroup(groupId, groupName) {
            // Close menu
            document.getElementById(`groupMenu-${groupId}`).classList.remove('show');
            
            // Load friends who can be added to this group
            fetch(`/friends/for-group/${groupId}`)
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        showNotification('error', 'Load Failed', d.message || 'Failed to load friends');
                        return;
                    }
                    
                    if (!d.friends.length) {
                        showNotification('info', 'No Friends Available', 'All your friends are already in this group or you have no friends to add');
                        return;
                    }
                    
                    // Show friend selection modal
                    showAddFriendsModal(groupId, groupName, d.friends);
                })
                .catch(() => {
                    showNotification('error', 'Load Failed', 'Failed to load friends');
                });
        }
        
        function showAddFriendsModal(groupId, groupName, friends) {
            const modal = document.createElement('div');
            modal.id = 'addFriendsModal';
            modal.className = 'modern-modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-backdrop"></div>
                <div class="modal-container add-members-modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <div class="modal-icon add-members-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="modal-title-content">
                                <span class="modal-main-title">Add Members</span>
                                <span class="modal-subtitle">to ${groupName}</span>
                            </div>
                        </div>
                        <button class="modal-close" id="cancelAddFriends">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="selection-info">
                            <div class="selection-stats">
                                <span class="available-count">${friends.length} friends available</span>
                                <span class="selected-count">0 selected</span>
                            </div>
                            <div class="selection-actions">
                                <button class="select-all-btn" id="selectAllFriends">
                                    <i class="fas fa-check-double"></i>
                                    Select All
                                </button>
                            </div>
                        </div>
                        <div class="friends-selection-container" id="friendsSelectionList">
                            ${friends.map(f => `
                                <div class="modern-friend-selection-item" data-friend-id="${f.id}">
                                    <div class="selection-checkbox">
                                        <input type="checkbox" id="friend-${f.id}" class="modern-checkbox">
                                        <label for="friend-${f.id}" class="checkbox-label"></label>
                                    </div>
                                    <div class="friend-avatar-modern">
                                        ${f.profile_picture ? `<img src="${f.profile_picture}" alt="${f.username}" />` : `<span class="avatar-text">${f.username.charAt(0).toUpperCase()}</span>`}
                                        <div class="online-status ${f.is_online ? 'online' : 'offline'}"></div>
                                    </div>
                                    <div class="friend-details">
                                        <div class="friend-name">${f.username}</div>
                                        <div class="friend-status">${f.is_online ? 'Online' : 'Last seen recently'}</div>
                                    </div>
                                    <div class="selection-indicator">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="modern-btn secondary-btn" id="cancelAddFriends2">Cancel</button>
                        <button class="modern-btn primary-btn" id="addSelectedFriends" disabled>
                            <i class="fas fa-user-plus"></i>
                            <span>Add Selected</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Add click handlers for friend selection
            modal.querySelectorAll('.modern-friend-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                    
                    updateSelectionCount();
                });
            });
            
            // Update selection count function
            function updateSelectionCount() {
                const selectedCount = modal.querySelectorAll('input[type="checkbox"]:checked').length;
                const selectedCountEl = modal.querySelector('.selected-count');
                const addBtn = modal.querySelector('#addSelectedFriends');
                
                selectedCountEl.textContent = `${selectedCount} selected`;
                addBtn.disabled = selectedCount === 0;
                
                if (selectedCount > 0) {
                    addBtn.innerHTML = `<i class="fas fa-user-plus"></i><span>Add ${selectedCount} Friend${selectedCount > 1 ? 's' : ''}</span>`;
                } else {
                    addBtn.innerHTML = `<i class="fas fa-user-plus"></i><span>Add Selected</span>`;
                }
            }
            
            // Select all functionality
            modal.querySelector('#selectAllFriends').addEventListener('click', function() {
                const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                    const item = checkbox.closest('.modern-friend-selection-item');
                    if (checkbox.checked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
                
                this.innerHTML = allChecked ? '<i class="fas fa-check-double"></i>Select All' : '<i class="fas fa-times"></i>Deselect All';
                updateSelectionCount();
            });
            
            // Add selected friends
            modal.querySelector('#addSelectedFriends').addEventListener('click', function() {
                const selectedFriends = Array.from(modal.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.id.replace('friend-', ''));
                
                if (!selectedFriends.length) {
                    showNotification('warning', 'No Selection', 'Please select at least one friend to add');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Adding Friends...';
                
                // Add friends one by one
                let addedCount = 0;
                let failedCount = 0;
                
                const addNextFriend = (index) => {
                    if (index >= selectedFriends.length) {
                        // All done
                        document.body.removeChild(modal);
                        document.body.style.overflow = 'auto';
                        
                        if (addedCount > 0) {
                            showNotification('success', 'Friends Added', `${addedCount} friend(s) added to ${groupName}`);
                            loadGroups(); // Refresh groups to update member count
                        }
                        if (failedCount > 0) {
                            showNotification('warning', 'Some Failed', `${failedCount} friend(s) could not be added`);
                        }
                        return;
                    }
                    
                    const friendId = selectedFriends[index];
                    fetch(`/groups/${groupId}/add-member`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ friend_id: friendId })
                    })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            addedCount++;
                        } else {
                            failedCount++;
                        }
                        addNextFriend(index + 1);
                    })
                    .catch(() => {
                        failedCount++;
                        addNextFriend(index + 1);
                    });
                };
                
                addNextFriend(0);
            });
            
            // Cancel buttons
            modal.querySelector('#cancelAddFriends').addEventListener('click', function() {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            });
            
            modal.querySelector('#cancelAddFriends2').addEventListener('click', function() {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            });
        }
        
        function viewGroupMembers(groupId, groupName) {
            // Close menu
            document.getElementById(`groupMenu-${groupId}`).classList.remove('show');
            
            fetch(`/groups/${groupId}/members`)
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        showNotification('error', 'Load Failed', d.message || 'Failed to load members');
                        return;
                    }
                    
                    showGroupMembersModal(groupId, groupName, d.members);
                })
                .catch(() => {
                    showNotification('error', 'Load Failed', 'Failed to load group members');
                });
        }
        
        function openGroupSettings(groupId, groupName) {
            // Close menu
            document.getElementById(`groupMenu-${groupId}`).classList.remove('show');
            
            // Load current settings
            fetch(`/groups/${groupId}/settings`)
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        showGroupSettingsModal(groupId, groupName, d.settings);
                    } else {
                        showNotification('error', 'Load Failed', d.message || 'Failed to load group settings');
                    }
                })
                .catch(() => {
                    showNotification('error', 'Load Failed', 'Failed to load group settings');
                });
        }
        
        function showGroupSettingsModal(groupId, currentName, settings) {
            const modal = document.createElement('div');
            modal.id = 'groupSettingsModal';
            modal.className = 'modern-modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-backdrop"></div>
                <div class="modal-container settings-modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <div class="modal-icon settings-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div class="modal-title-content">
                                <span class="modal-main-title">Group Settings</span>
                                <span class="modal-subtitle">Customize your group</span>
                            </div>
                        </div>
                        <button class="modal-close" id="cancelGroupSettings">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="settings-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-tag"></i>
                                </div>
                                <div class="section-info">
                                    <h4>Basic Information</h4>
                                    <p>Update your group's name and description</p>
                                </div>
                            </div>
                            <div class="modern-input-group">
                                <label class="modern-label">
                                    <i class="fas fa-users"></i>
                                    <span>Group Name</span>
                                </label>
                                <input type="text" id="editGroupName" class="modern-input" value="${settings.name}" maxlength="50" placeholder="Enter group name">
                                <div class="input-helper">Choose a memorable name for your group</div>
                            </div>
                            <div class="modern-input-group">
                                <label class="modern-label">
                                    <i class="fas fa-align-left"></i>
                                    <span>Description</span>
                                </label>
                                <textarea id="editGroupDescription" class="modern-input" rows="3" placeholder="Describe what this group is about...">${settings.description || ''}</textarea>
                                <div class="input-helper">Help members understand the purpose of this group</div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="section-info">
                                    <h4>Privacy Settings</h4>
                                    <p>Control who can join your group</p>
                                </div>
                            </div>
                            <div class="privacy-toggle-modern">
                                <div class="toggle-info">
                                    <div class="toggle-icon-modern">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div class="toggle-details">
                                        <span class="toggle-title">Private Group</span>
                                        <span class="toggle-desc">Only invited members can join this group</span>
                                    </div>
                                </div>
                                <label class="modern-toggle">
                                    <input type="checkbox" id="editGroupPrivate" class="toggle-input" ${settings.is_private ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-section danger-section">
                            <div class="section-header">
                                <div class="section-icon danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="section-info">
                                    <h4>Danger Zone</h4>
                                    <p>Irreversible actions for this group</p>
                                </div>
                            </div>
                            <div class="danger-actions">
                                <button class="danger-action-btn" id="deleteGroupBtn">
                                    <i class="fas fa-trash"></i>
                                    <div class="action-info">
                                        <span class="action-title">Delete Group</span>
                                        <span class="action-desc">Permanently delete this group and all its data</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="modern-btn secondary-btn" id="cancelGroupSettings2">Cancel</button>
                        <button class="modern-btn primary-btn" id="saveGroupSettings">
                            <i class="fas fa-save"></i>
                            <span>Save Changes</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Save settings
            modal.querySelector('#saveGroupSettings').addEventListener('click', function() {
                const name = document.getElementById('editGroupName').value.trim();
                const description = document.getElementById('editGroupDescription').value.trim();
                const isPrivate = document.getElementById('editGroupPrivate').checked;
                
                if (!name) {
                    showNotification('error', 'Validation Error', 'Group name is required');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Saving...';
                
                fetch(`/groups/${groupId}/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, description, is_private: isPrivate })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        showNotification('success', 'Settings Updated', 'Group settings updated successfully');
                        document.body.removeChild(modal);
                        document.body.style.overflow = 'auto';
                        loadGroups(); // Refresh groups list
                    } else {
                        showNotification('error', 'Update Failed', d.message || 'Failed to update settings');
                        this.disabled = false;
                        this.textContent = 'Save Changes';
                    }
                })
                .catch(() => {
                    showNotification('error', 'Update Failed', 'Failed to update group settings');
                    this.disabled = false;
                    this.textContent = 'Save Changes';
                });
            });
            
            // Cancel buttons
            modal.querySelector('#cancelGroupSettings').addEventListener('click', function() {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            });
            
            modal.querySelector('#cancelGroupSettings2').addEventListener('click', function() {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            });
            
            // Delete group functionality
            modal.querySelector('#deleteGroupBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
                    fetch(`/groups/${groupId}/delete`, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showNotification('success', 'Group Deleted', 'The group has been permanently deleted');
                            document.body.removeChild(modal);
                            document.body.style.overflow = 'auto';
                            loadGroups(); // Refresh groups list
                        } else {
                            showNotification('error', 'Delete Failed', d.message || 'Failed to delete group');
                        }
                    })
                    .catch(() => {
                        showNotification('error', 'Delete Failed', 'Failed to delete group');
                    });
                }
            });
        }
        
        function leaveGroup(groupId, groupName) {
            // Close menu
            document.getElementById(`groupMenu-${groupId}`).classList.remove('show');
            
            if (!confirm(`Are you sure you want to leave "${groupName}"?`)) {
                return;
            }
            
            fetch(`/groups/${groupId}/leave`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Left Group', `You have left "${groupName}"`);
                    loadGroups(); // Refresh groups list
                    // Close group chat if it's open
                    if (currentGroupId === groupId) {
                        document.getElementById('groupChatModal').style.display = 'none';
                        document.body.style.overflow = 'auto';
                        currentGroupId = null;
                    }
                } else {
                    showNotification('error', 'Leave Failed', d.message || 'Failed to leave group');
                }
            })
            .catch(() => {
                showNotification('error', 'Leave Failed', 'Failed to leave group');
            });
        }
        
        function showGroupMembersModal(groupId, groupName, members) {
            // Check current user's role in the group
            const currentUserMember = members.find(m => String(m.id) === String(window._selfId));
            const isCreator = currentUserMember && currentUserMember.role === 'creator';
            const isAdmin = currentUserMember && (currentUserMember.role === 'admin' || currentUserMember.role === 'creator');
            
            console.log('Current user ID:', window._selfId);
            console.log('Current user member:', currentUserMember);
            console.log('Is creator:', isCreator);
            console.log('Is admin:', isAdmin);
            
            const modal = document.createElement('div');
            modal.id = 'groupMembersModal';
            modal.className = 'modern-modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-backdrop"></div>
                <div class="modal-container members-modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <div class="modal-icon members-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="modal-title-content">
                                <span class="modal-main-title">${groupName}</span>
                                <span class="modal-subtitle">${members.length} members</span>
                            </div>
                        </div>
                        <button class="modal-close" id="closeMembersModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="members-info">
                            <div class="role-badge ${currentUserMember ? currentUserMember.role : 'member'}">
                                <i class="fas ${currentUserMember && currentUserMember.role === 'creator' ? 'fa-crown' : currentUserMember && currentUserMember.role === 'admin' ? 'fa-shield-alt' : 'fa-user'}"></i>
                                <span>Your role: ${currentUserMember ? currentUserMember.role : 'member'}</span>
                            </div>
                            <div class="members-stats">
                                <div class="stat-item">
                                    <span class="stat-number">${members.filter(m => m.role === 'creator').length}</span>
                                    <span class="stat-label">Creator</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${members.filter(m => m.role === 'admin').length}</span>
                                    <span class="stat-label">Admins</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${members.filter(m => m.role === 'member').length}</span>
                                    <span class="stat-label">Members</span>
                                </div>
                            </div>
                        </div>
                        <div class="members-list-container" id="membersListContainer">
                            ${members.map(m => {
                                const roleColor = m.role === 'creator' ? '#10b981' : m.role === 'admin' ? '#f59e0b' : '#64748b';
                                const roleIcon = m.role === 'creator' ? 'fas fa-crown' : m.role === 'admin' ? 'fas fa-shield-alt' : 'fas fa-user';
                                const isSelf = String(m.id) === String(window._selfId);
                                const canKick = isAdmin && !isSelf && m.role !== 'creator' && (isCreator || m.role === 'member');
                                const canPromote = isCreator && !isSelf && m.role === 'member';
                                const canDemote = isCreator && !isSelf && m.role === 'admin';
                                const hasAnyAction = canKick || canPromote || canDemote;
                                
                                console.log(`Member ${m.username}: role=${m.role}, isSelf=${isSelf}, isAdmin=${isAdmin}, isCreator=${isCreator}, canKick=${canKick}, hasAnyAction=${hasAnyAction}`);
                                
                                return `
                                    <div class="modern-member-item ${isSelf ? 'self' : ''}">
                                        <div class="member-avatar-section">
                                            <div class="member-avatar">
                                                ${m.profile_picture ? `<img src="${m.profile_picture}" alt="${m.username}" />` : `<span class="avatar-text">${m.username.charAt(0).toUpperCase()}</span>`}
                                                <div class="role-indicator ${m.role}">
                                                    <i class="${roleIcon}"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">
                                                ${m.username}
                                                ${isSelf ? '<span class="you-badge">You</span>' : ''}
                                            </div>
                                            <div class="member-role" style="color:${roleColor};">
                                                <i class="${roleIcon}"></i>
                                                ${m.role.charAt(0).toUpperCase() + m.role.slice(1)}
                                            </div>
                                            <div class="member-joined">
                                                Joined ${new Date(m.joined_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                            </div>
                                        </div>
                                        <div class="member-actions">
                                            ${hasAnyAction ? `
                                                <div class="dropdown member-dropdown-container">
                                                    <button class="member-action-btn" onclick="toggleMemberMenu(event, '${m.id}')" title="Member Actions">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="member-dropdown modern-dropdown" id="memberMenu-${m.id}">
                                                        ${canPromote ? `<button class="dropdown-item promote" onclick="promoteMember(${groupId}, ${m.id}, '${m.username}')"><i class="fas fa-arrow-up"></i> Promote to Admin</button>` : ''}
                                                        ${canDemote ? `<button class="dropdown-item demote" onclick="demoteMember(${groupId}, ${m.id}, '${m.username}')"><i class="fas fa-arrow-down"></i> Demote to Member</button>` : ''}
                                                        ${canKick ? `<button class="dropdown-item danger" onclick="kickMember(${groupId}, ${m.id}, '${m.username}')"><i class="fas fa-user-times"></i> Remove Member</button>` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="modern-btn secondary-btn" id="closeMembersModal2">
                            <i class="fas fa-times"></i>
                            <span>Close</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Close buttons
            modal.querySelector('#closeMembersModal').addEventListener('click', function() {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            });
            
            modal.querySelector('#closeMembersModal2').addEventListener('click', function() {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            });
            
            // Close dropdowns when clicking outside
            modal.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    modal.querySelectorAll('.member-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                }
            });
        }
        
        function loadGroups() {
            fetch('/groups/list')
                .then(r => r.json())
                .then(d => {
                    const container = document.getElementById('groupsList');
                    if (!d.success) {
                        container.innerHTML = '<div style="text-align:center; padding:60px; color:#ef4444;"><i class="fas fa-exclamation-triangle" style="font-size:3rem; margin-bottom:16px; opacity:0.3;"></i><div>Failed to load groups</div></div>';
                        return;
                    }
                    
                    if (!d.groups.length) {
                        container.innerHTML = `
                            <div style="text-align:center; padding:80px 40px; color:#64748b; grid-column: 1 / -1;">
                                <i class="fas fa-users" style="font-size:4rem; margin-bottom:24px; opacity:0.3;"></i>
                                <div style="font-size:1.3rem; font-weight:600; margin-bottom:8px;">No groups yet</div>
                                <div style="font-size:1rem; margin-bottom:24px;">Create your first group to start collaborating</div>
                                <button class="modern-btn primary-btn" onclick="document.getElementById('createGroupBtn').click()">
                                    <i class="fas fa-plus"></i>
                                    <span>Create Group</span>
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    // Update stats
                    document.getElementById('totalGroupsCount').textContent = d.groups.length;
                    document.getElementById('totalMembersCount').textContent = d.groups.reduce((sum, g) => sum + g.member_count, 0);
                    document.getElementById('activeChatsCount').textContent = d.groups.filter(g => g.member_count > 1).length;
                    
                    container.innerHTML = d.groups.map(g => {
                        return `
                        <div class="modern-group-card" data-group-id="${g.id}">
                            <div class="group-card-header">
                                <div class="group-card-menu">
                                    <button class="group-menu-btn" onclick="toggleGroupMenu(event, ${g.id})">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="friend-dropdown" id="groupMenu-${g.id}">
                                        <button class="friend-dropdown-item" onclick="addFriendsToGroup(${g.id}, '${g.name}')">
                                            <i class="fas fa-user-plus"></i> Add Friends
                                        </button>
                                        <button class="friend-dropdown-item" onclick="viewGroupMembers(${g.id}, '${g.name}')">
                                            <i class="fas fa-users"></i> View Members
                                        </button>
                                        <button class="friend-dropdown-item" onclick="openGroupSettings(${g.id}, '${g.name}')">
                                            <i class="fas fa-cog"></i> Group Settings
                                        </button>
                                        <button class="friend-dropdown-item danger" onclick="leaveGroup(${g.id}, '${g.name}')">
                                            <i class="fas fa-sign-out-alt"></i> Leave Group
                                        </button>
                                    </div>
                                </div>
                                <div class="group-avatar-section">
                                    <div class="group-avatar-large">
                                        ${g.name.charAt(0).toUpperCase()}
                                        ${g.is_private ? '<div class="privacy-indicator"><i class="fas fa-lock"></i></div>' : ''}
                                    </div>
                                    <div class="group-info">
                                        <h3 class="group-name">${g.name}</h3>
                                        <div class="group-meta">
                                            <span><i class="fas fa-users"></i> ${g.member_count} members</span>
                                            <span><i class="fas fa-crown"></i> ${g.user_role}</span>
                                        </div>
                                    </div>
                                </div>
                                ${g.description ? `<p class="group-description">${g.description}</p>` : ''}
                            </div>
                            <div class="group-card-content">
                                <div class="group-stats">
                                    <div class="group-stat">
                                        <span class="group-stat-number">${g.member_count}</span>
                                        <span class="group-stat-label">Members</span>
                                    </div>
                                    <div class="group-stat">
                                        <span class="group-stat-number">${g.is_private ? 'Private' : 'Public'}</span>
                                        <span class="group-stat-label">Type</span>
                                    </div>
                                    <div class="group-stat">
                                        <span class="group-stat-number">${g.user_role}</span>
                                        <span class="group-stat-label">Role</span>
                                    </div>
                                </div>
                                <div class="group-actions">
                                    <button class="group-action-btn primary-action" onclick="openGroupChat(${g.id}, '${g.name}')">
                                        <i class="fas fa-comments"></i>
                                        <span>Open Chat</span>
                                    </button>
                                    <button class="group-action-btn secondary-action" onclick="viewGroupMembers(${g.id}, '${g.name}')">
                                        <i class="fas fa-users"></i>
                                        <span>Members</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                })
                .catch(() => {
                    document.getElementById('groupsList').innerHTML = '<div style="text-align:center; padding:60px; color:#ef4444;"><i class="fas fa-exclamation-triangle" style="font-size:3rem; margin-bottom:16px; opacity:0.3;"></i><div>Error loading groups</div></div>';
                });
        }
        
        function openGroupChat(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('groupChatTitle').textContent = groupName;
            document.getElementById('groupChatAvatar').textContent = groupName.charAt(0).toUpperCase();
            document.getElementById('groupChatModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Load group members count
            fetch(`/groups/${groupId}/members`)
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        document.getElementById('groupMemberCount').textContent = `${d.members.length} members`;
                    }
                })
                .catch(() => {});
            
            // Load group messages
            loadGroupMessages(groupId);
            
            // Join group room for real-time updates
            socket.emit('join_group_room', { group_id: groupId });
        }
        
        function loadGroupMessages(groupId) {
            const container = document.getElementById('groupMessages');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Loading messages...</div>';
            
            fetch(`/groups/${groupId}/messages`)
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        container.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">Failed to load messages</div>';
                        return;
                    }
                    
                    if (!d.messages.length) {
                        container.innerHTML = '<div style="text-align:center; padding:40px; color:#64748b;">No messages yet. Start the conversation!</div>';
                        return;
                    }
                    
                    container.innerHTML = d.messages.map(m => {
                        const isOwn = String(m.sender_id) === String(window._selfId);
                        const time = new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        return `
                            <div style="margin-bottom:15px; ${isOwn ? 'text-align:right;' : 'text-align:left;'}">
                                <div style="display:inline-block; max-width:70%; padding:10px 15px; border-radius:15px; ${isOwn ? 'background:#6366f1; color:white;' : 'background:white; border:1px solid #e2e8f0;'}">
                                    ${!isOwn ? `<div style="font-size:0.8rem; font-weight:600; margin-bottom:5px; color:#6366f1;">${m.sender_name}</div>` : ''}
                                    <div>${escapeHtml(m.content)}</div>
                                    <div style="font-size:0.75rem; margin-top:5px; opacity:0.7;">${time}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                })
                .catch(() => {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">Error loading messages</div>';
                });
        }
        
        function sendGroupMessage() {
            const input = document.getElementById('groupMessageInput');
            const content = input.value.trim();
            
            if (!content || !currentGroupId) return;
            
            socket.emit('send_group_message', {
                group_id: currentGroupId,
                content: content
            });
            
            input.value = '';
        }
        
        // Group event listeners
        document.getElementById('createGroupBtn').addEventListener('click', function() {
            document.getElementById('createGroupModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        });
        
        document.getElementById('cancelCreateGroup').addEventListener('click', function() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            document.getElementById('groupPrivate').checked = false;
        });
        
        document.getElementById('cancelCreateGroup2').addEventListener('click', function() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            document.getElementById('groupPrivate').checked = false;
        });
        
        document.getElementById('createGroupSubmit').addEventListener('click', function() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            const isPrivate = document.getElementById('groupPrivate').checked;
            
            if (!name) {
                showNotification('error', 'Validation Error', 'Group name is required');
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Creating...';
            
            fetch('/groups/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, description, is_private: isPrivate })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showNotification('success', 'Group Created', d.message);
                    document.getElementById('createGroupModal').style.display = 'none';
                    document.body.style.overflow = 'auto';
                    document.getElementById('groupName').value = '';
                    document.getElementById('groupDescription').value = '';
                    document.getElementById('groupPrivate').checked = false;
                    loadGroups();
                } else {
                    showNotification('error', 'Creation Failed', d.message);
                }
            })
            .catch(() => {
                showNotification('error', 'Creation Failed', 'Failed to create group');
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'Create Group';
            });
        });
        
        document.getElementById('closeGroupChat').addEventListener('click', function() {
            document.getElementById('groupChatModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            if (currentGroupId) {
                socket.emit('leave_group_room', { group_id: currentGroupId });
                currentGroupId = null;
            }
        });
        
        document.getElementById('sendGroupMessage').addEventListener('click', sendGroupMessage);
        
        document.getElementById('groupMessageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendGroupMessage();
            }
        });
        
        // Socket listeners for group messages
        socket.on('new_group_message', (msg) => {
            if (currentGroupId && String(msg.group_id) === String(currentGroupId)) {
                const container = document.getElementById('groupMessages');
                const isOwn = String(msg.sender_id) === String(window._selfId);
                const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const messageEl = document.createElement('div');
                messageEl.style.marginBottom = '15px';
                messageEl.style.textAlign = isOwn ? 'right' : 'left';
                
                messageEl.innerHTML = `
                    <div style="display:inline-block; max-width:70%; padding:10px 15px; border-radius:15px; ${isOwn ? 'background:#6366f1; color:white;' : 'background:white; border:1px solid #e2e8f0;'}">
                        ${!isOwn ? `<div style="font-size:0.8rem; font-weight:600; margin-bottom:5px; color:#6366f1;">${msg.sender_name}</div>` : ''}
                        <div>${escapeHtml(msg.content)}</div>
                        <div style="font-size:0.75rem; margin-top:5px; opacity:0.7;">${time}</div>
                    </div>
                `;
                
                container.appendChild(messageEl);
                container.scrollTop = container.scrollHeight;
            }
        });
        
        // File sharing functionality
        function handleFileUpload(file) {
            if (file.size > 5 * 1024 * 1024) {
                showNotification('error', 'File Too Large', 'File size must be less than 5MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload-file', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    // Send file message
                    if (currentChatUserId) {
                        socket.emit('send_message', {
                            to: currentChatUserId,
                            content: `Shared a file: ${d.file.original_name}`,
                            message_type: 'file',
                            file_url: d.file.url,
                            file_name: d.file.original_name,
                            file_size: d.file.size
                        });
                    }
                    showNotification('success', 'File Uploaded', 'File shared successfully');
                } else {
                    showNotification('error', 'Upload Failed', d.message);
                }
            })
            .catch(() => {
                showNotification('error', 'Upload Failed', 'Failed to upload file');
            });
        }
        
        // WebRTC functionality for voice/video calls
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let isCallActive = false;
        
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        function startCall(userId, callType = 'audio') {
            if (isCallActive) {
                showNotification('warning', 'Call Active', 'A call is already in progress');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({
                audio: true,
                video: callType === 'video'
            })
            .then(stream => {
                localStream = stream;
                isCallActive = true;
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // Add local stream
                stream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, stream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('webrtc_signal', {
                            target_id: userId,
                            signal: {
                                type: 'ice-candidate',
                                candidate: event.candidate
                            }
                        });
                    }
                };
                
                // Create offer
                return peerConnection.createOffer();
            })
            .then(offer => {
                return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
                socket.emit('call_user', {
                    user_id: userId,
                    call_type: callType
                });
                
                socket.emit('webrtc_signal', {
                    target_id: userId,
                    signal: {
                        type: 'offer',
                        offer: peerConnection.localDescription
                    }
                });
                
                showNotification('info', 'Calling', 'Calling user...');
            })
            .catch(error => {
                console.error('Error starting call:', error);
                showNotification('error', 'Call Failed', 'Failed to start call');
                endCall();
            });
        }
        
        function answerCall(callerId, accept = true) {
            socket.emit('answer_call', {
                caller_id: callerId,
                answer: accept
            });
            
            if (!accept) {
                showNotification('info', 'Call Declined', 'Call declined');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    isCallActive = true;
                    
                    peerConnection = new RTCPeerConnection(rtcConfig);
                    
                    stream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, stream);
                    });
                    
                    peerConnection.ontrack = (event) => {
                        remoteStream = event.streams[0];
                    };
                    
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            socket.emit('webrtc_signal', {
                                target_id: callerId,
                                signal: {
                                    type: 'ice-candidate',
                                    candidate: event.candidate
                                }
                            });
                        }
                    };
                })
                .catch(error => {
                    console.error('Error answering call:', error);
                    showNotification('error', 'Call Failed', 'Failed to answer call');
                });
        }
        
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            isCallActive = false;
            showNotification('info', 'Call Ended', 'Call has ended');
        }
        
        // Socket listeners for WebRTC
        socket.on('incoming_call', (data) => {
            if (isCallActive) {
                socket.emit('answer_call', { caller_id: data.caller_id, answer: false });
                return;
            }
            
            const accept = confirm(`Incoming ${data.call_type} call from ${data.caller_name}. Accept?`);
            answerCall(data.caller_id, accept);
        });
        
        socket.on('call_answered', (data) => {
            if (data.answer) {
                showNotification('success', 'Call Accepted', 'Call was accepted');
            } else {
                showNotification('info', 'Call Declined', 'Call was declined');
                endCall();
            }
        });
        
        socket.on('webrtc_signal', (data) => {
            if (!peerConnection) return;
            
            const signal = data.signal;
            
            if (signal.type === 'offer') {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        socket.emit('webrtc_signal', {
                            target_id: data.sender_id,
                            signal: {
                                type: 'answer',
                                answer: peerConnection.localDescription
                            }
                        });
                    });
            } else if (signal.type === 'answer') {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.answer));
            } else if (signal.type === 'ice-candidate') {
                peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
            }
        });
        
        socket.on('call_ended', () => {
            endCall();
        });
        

        

        
        // Initialize chat system on page load
        if (document.getElementById('messages')) {
            // Auto-initialize if messages section is already visible
            const messagesSection = document.getElementById('messages');
            if (messagesSection.style.display !== 'none') {
                initializeChatSystem();
            }
        }
        
        // Profile picture functionality
        const uploadProfilePicBtn = document.getElementById('uploadProfilePicBtn');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const removeProfilePicBtn = document.getElementById('removeProfilePicBtn');
        const currentProfilePic = document.getElementById('currentProfilePic');
        
        if (uploadProfilePicBtn && profilePictureInput) {
            uploadProfilePicBtn.addEventListener('click', function() {
                profilePictureInput.click();
            });
            
            profilePictureInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Ensure this is for current user only
                if (!window._selfId) return;
                
                if (!file.type.startsWith('image/')) {
                    showNotification('error', 'Invalid File', 'Please select an image file');
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('error', 'File Too Large', 'Image must be less than 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    fetch('/upload-profile-picture', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ image: imageData })
                    })
                    .then(r => r.json())
                    .then(d => {
                        // Update current profile picture display for current user only
                        if (currentProfilePic.tagName === 'IMG') {
                            currentProfilePic.src = imageData;
                        } else {
                            const img = document.createElement('img');
                            img.src = imageData;
                            img.alt = 'Profile Picture';
                            img.id = 'currentProfilePic';
                            currentProfilePic.parentNode.replaceChild(img, currentProfilePic);
                        }
                        
                        // Update header avatar for current user only
                        const headerAvatar = document.querySelector('.user-avatar');
                        if (headerAvatar) {
                            headerAvatar.innerHTML = `<img src="${imageData}" alt="Profile Picture" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        }
                        
                        // Show remove button
                        const removeBtn = document.getElementById('removeProfilePicBtn');
                        if (removeBtn) {
                            removeBtn.style.display = 'flex';
                        }
                        
                        showNotification('success', 'Profile Updated', 'Profile picture uploaded successfully');
                        loadAcceptedFriends();
                        loadConversations();
                    })
                    .catch(() => {
                        showNotification('error', 'Upload Failed', 'Failed to upload profile picture');
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        
        if (removeProfilePicBtn) {
            removeProfilePicBtn.addEventListener('click', function() {
                // Ensure this is for current user only
                if (!window._selfId) return;
                
                if (!confirm('Are you sure you want to remove your profile picture?')) {
                    return;
                }
                
                fetch('/remove-profile-picture', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(r => r.json())
                .then(d => {
                    // Revert to default avatar
                    const defaultAvatar = document.createElement('div');
                    defaultAvatar.className = 'default-avatar';
                    defaultAvatar.id = 'currentProfilePic';
                    defaultAvatar.textContent = window._selfUsername.charAt(0).toUpperCase();
                    currentProfilePic.parentNode.replaceChild(defaultAvatar, currentProfilePic);
                    
                    // Update header avatar for current user only
                    const headerAvatar = document.querySelector('.user-avatar');
                    if (headerAvatar) {
                        headerAvatar.innerHTML = window._selfUsername.charAt(0).toUpperCase();
                    }
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeProfilePicBtn');
                    if (removeBtn) {
                        removeBtn.style.display = 'none';
                    }
                    
                    showNotification('success', 'Profile Updated', 'Profile picture removed successfully');
                    loadAcceptedFriends();
                    loadConversations();
                })
                .catch(() => {
                    showNotification('error', 'Remove Failed', 'Failed to remove profile picture');
                });
            });
        }
    </script>
</body>
</html>